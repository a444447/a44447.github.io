# åç¨‹å…¥é—¨

## æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåç¨‹å¯ä»¥æŒ‰è°ƒåº¦çš„åˆ†é…æ¥åˆ†ä¸ºï¼š**å¯¹ç§°åç¨‹å’Œéå¯¹ç§°åç¨‹**

å¦‚æœæŒ‰æ ˆçš„åˆ†é…æ–¹å¼åˆå¯ä»¥åˆ†ä¸º **æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹**

### æœ‰æ ˆåç¨‹

ç†è§£æœ‰æ ˆåç¨‹çš„æ—¶å€™æœ€å¥½ç»“åˆ **æ™®é€šå‡½æ•°è°ƒç”¨çš„æ ˆå¸§**ã€‚å½“æ™®é€šå‡½æ•°è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ ˆå¸§ã€‚

> ä¸€èˆ¬æ¥è¯´ç”Ÿæˆçš„æ ˆå¸§æ˜¯ï¼Œå…ˆå‹å…¥rbp(ä¸Šä¸€ä¸ªæ ˆå¸§çš„åŸºåœ°å€ï¼Œè¿™æ ·æ‰èƒ½è¿”å›)ï¼Œç„¶åæ›´æ–°å½“å‰çš„rbpï¼Œå†ä¸€æ¬¡å‹å…¥å…¥å‚ä»¥åŠå‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚

æ‰€ä»¥å¯¹äºæ™®é€šå‡½æ•°æ¥è¯´ï¼Œæ— è®ºæ˜¯å‡½æ•°çš„åˆ‡æ¢è¿˜æ˜¯é€’å½’ï¼Œæœ¬è´¨å°±æ˜¯æ ˆå¸§çš„åˆ‡æ¢ã€‚æœ‰æ ˆåç¨‹åˆ©ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªæ€æƒ³ï¼Œå®ƒåˆ†é…ä¸€ä¸ªå†…å­˜ç©ºé—´å­˜å‚¨**å½“å‰çš„ä¸Šä¸‹æ–‡**ï¼Œè¿™æ ·å°±å¯ä»¥æ‰‹åŠ¨åˆ‡æ¢å‡½æ•°ï¼Œæƒ³è¦æ¢å¤å‡½æ•°åªè¦å»æŒæœ‰å‡½æ•°ä¸Šä¸‹æ–‡çš„é‚£ä¸ªå†…å­˜åŒºåŸŸæ‹¿å‡ºä¸Šä¸‹æ–‡å³å¯ã€‚è¿™æ ·çš„èƒ½å¤Ÿè‡ªç”±åˆ‡æ¢çš„**æœ‰æ ˆåç¨‹ä¹Ÿæ˜¯å¯¹ç§°åç¨‹ã€‚**

å¯ä»¥ç»“åˆlinuxçš„`ucontext`åº“æ¥çœ‹è¿™ç‚¹ã€‚u

### æ— æ ˆåç¨‹

æ— æ ˆåç¨‹å¯ä»¥æŠŠåç¨‹å½“ä½œä¸€ä¸ªç±»ï¼Œé‡Œé¢æœ‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„æˆå‘˜å‡½æ•°ï¼Œä»¥åŠè®°å½•çŠ¶æ€çš„æˆå‘˜å˜é‡ã€‚"ç±»"ä¸­çš„æˆå‘˜å‡½æ•°å°±åƒçŠ¶æ€æœºï¼Œæ•´ä¸ªå‡½æ•°è¢«åˆ†ä¸ºäº†å‡ ä¸ªéƒ¨åˆ†ï¼Œå½“é‡åˆ°æŸä¸ªèŠ‚ç‚¹éœ€è¦åˆ‡æ¢åç¨‹çš„æ—¶å€™ï¼Œä¼šæ”¹å˜è®°å½•çŠ¶æ€çš„æˆå‘˜å˜é‡ã€‚å½“ä¸‹ä¸€æ¬¡æ¢å¤çš„æ—¶å€™ï¼Œå†æ¬¡æ‰§è¡Œ"ç±»"çš„æˆå‘˜å‡½æ•°ï¼Œå°±ä¼šæ ¹æ®**ä¸åŒçš„çŠ¶æ€ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªéƒ¨åˆ†**ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯è‡ªè¡Œå®ç°åˆ‡æ¢çš„è°ƒåº¦é€»è¾‘ã€‚

**æ‰€æœ‰çš„åç¨‹å…±ç”¨çš„éƒ½æ˜¯ä¸€ä¸ªæ ˆï¼Œå³ç³»ç»Ÿæ ˆï¼Œä¹Ÿå°±ä¸å¿…è‡ªè¡Œå»ç»™åç¨‹åˆ†é…æ ˆï¼Œå› ä¸ºæ˜¯å‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿä¸å¿…å»æ˜¾å¼çš„ä¿å­˜å¯„å­˜å™¨çš„å€¼ã€‚**

è™½ç„¶æˆ‘ä»¬è¯´æ— æ ˆåç¨‹ä¸éœ€è¦å’Œæœ‰æ ˆåç¨‹ä¸€æ ·ä¸ºæ ˆä¿¡æ¯å¼€è¾Ÿç©ºé—´ï¼Œ*æ— æ ˆåç¨‹ä»ç„¶éœ€è¦å†…å­˜ç©ºé—´å­˜å‚¨å½“å‰çŠ¶æ€ï¼Œåªæ˜¯å­˜å‚¨çš„å†…å®¹ä¸æœ‰æ ˆåç¨‹ä¸åŒ*ã€‚è€Œä¸”æ— æ ˆåç¨‹å±äºéå¯¹ç§°åç¨‹ï¼Œå› æ­¤å®ƒæ— æ³•å†ä»»æ„å‡½æ•°è°ƒç”¨å±‚çº§æŒ‚èµ·ã€‚

c++20æ˜¯ **æ— æ ˆåç¨‹**ã€‚æƒ³ä¸€ä¸‹cä¸­é€šè¿‡label-gotoè¿™æ ·çš„æ–¹å¼è¿›è¡Œè·³è½¬ï¼Œ C++ åç¨‹åå¤§å®¶å¯ä»¥è§‚å¯Ÿåˆ°åç¨‹çš„æ±‡ç¼–ä»£ç å­˜åœ¨å¤§é‡çš„ label å’Œ jmp æŒ‡ä»¤ï¼Œè¿™æ­£å¥½å¯¹åº”äº†ä¸Šè¿°è®²åˆ°çš„çŠ¶æ€æœºã€‚



### c++ åç¨‹è®¾è®¡æ€è·¯

æˆ‘ä»¬ä¹‹å‰è¯´äº†ï¼Œå¯¹äºæ— æ ˆåç¨‹ï¼Œ*å®ƒæ˜¯æŠŠåç¨‹å½“ä½œä¸€ä¸ªç±»ï¼Œå¹¶ä¸”åœ¨éœ€è¦åˆ‡æ¢çš„åœ°æ–¹åŠ å…¥è°ƒåº¦ç‚¹ï¼Œå‡½æ•°è‡ªç„¶å°±è¢«åˆ’åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†*ã€‚æ‰€ä»¥c++åç¨‹å†…ç½®äº†å‡ ä¸ªå…³é”®å­—æŠŠå‡½æ•°è¿›è¡Œåˆ‡åˆ†ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯è¿™ä¸ªå…³é”®å­—æŠŠå‡½æ•°è®¾ç½®äº†å‡ ä¸ªè°ƒåº¦ç‚¹ï¼‰

C++ çš„å‡½æ•°åŒ…å«æŒ‡å®šå…³é”®å­—ï¼ˆ**co_awaitï¼Œco_yieldï¼Œco_return**ï¼‰æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶çœ‹ä½œåç¨‹ï¼Œè€Œåœ¨å…³é”®å­—å‡ºç°çš„åœ°æ–¹ç¼–è¯‘å™¨ä¼šå®‰æ’è°ƒåº¦ç‚¹ï¼Œåœ¨è°ƒåº¦ç‚¹ç”¨æˆ·å¯ä»¥ä½¿ç”¨åç¨‹çš„æ–¹æ³•æ¥æŒ‡å®šåç¨‹æ˜¯ç»§ç»­è¿è¡Œè¿˜æ˜¯é€‰æ‹©åˆ‡æ¢æ‰§è¡Œæµç¨‹ã€‚



> **â“ C++ åç¨‹çš„åˆ›å»ºéœ€è¦é¢å¤–çš„å†…å­˜ï¼Œä¸ºä½•è¯´æ˜¯æ— æ ˆåç¨‹ï¼Ÿ** C++ åç¨‹ä¸ä¿å­˜æ ˆçŠ¶æ€ï¼Œè€Œæ˜¯é€šè¿‡å¯¹åç¨‹çŠ¶æ€æœºçš„è®¾è®¡ï¼Œä½¿ç”¨äº†å †å†…å­˜ä¿å­˜è‡ªèº«è¿è¡Œçš„æŸäº›çŠ¶æ€ï¼Œå› æ­¤å¯ä»¥ç†è§£ä¸ºä»ç„¶éœ€è¦é¢å¤–åˆ†é…å†…å­˜ï¼Œä½†ä¿å­˜çš„å¹¶ä¸æ˜¯æ ˆç»“æ„å› æ­¤ä»å®šä¹‰ä¸Šè®²å±äºæ— æ ˆåç¨‹

> **â“ æ€ä¹ˆç†è§£ C++ åç¨‹æ˜¯éå¯¹ç§°åç¨‹ï¼Ÿ** åœ¨éå¯¹ç§°åç¨‹ä¸­ï¼Œåç¨‹çš„æ§åˆ¶æµæ˜¯å•å‘çš„ï¼Œåç¨‹è®©å‡ºæ§åˆ¶æƒæ—¶åªèƒ½è¿”å›ç»™å®ƒçš„ç›´æ¥è°ƒç”¨è€…ã€‚C++20 åç¨‹é€šè¿‡ co_await æŒ‚èµ·æ—¶ï¼Œä¼šè¿”å›åˆ°è°ƒç”¨è€…æˆ–æ¢å¤è€…ï¼Œ**è€Œä¸æ˜¯ç›´æ¥åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹**ï¼Œè€Œå¯¹ç§°åç¨‹è®©å‡ºæ§åˆ¶æƒæ—¶å¯ä»¥éšæ„æŒ‡å®šåç¨‹ã€‚ åœ¨åç»­çš„è®²è§£ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° C++ åç¨‹å¯ä»¥é€šè¿‡å¯¹ç§°è½¬æ¢ä¼˜åŒ–æ¥å®ç°å¯¹ç§°åç¨‹çš„è¡Œä¸ºã€‚

### promise

è¦å†™ä¸€ä¸ªåç¨‹å‡½æ•°ï¼Œc++è§„å®šäº†éœ€è¦è¿”å›ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„ç±»`UserFacing`ï¼Œ è¿™ä¸ªç±»åœ¨æ–¹æ³•ä¸Šæ²¡æœ‰é™åˆ¶ï¼Œéœ€è¦æä¾›è¯¥ç±»çš„promise_typeï¼Œåªè¦æ»¡è¶³äº†è¿™ä¸ªå°±å¯ä»¥ä½œä¸ºåç¨‹å‡½æ•°çš„è¿”å›å€¼ã€‚

```
class UserFacing
{
public:
  class promise_type; // UsingFacing éœ€è¦æ»¡è¶³çš„é™åˆ¶
};

UserFacing coro() // åç¨‹è¿”å›å€¼è¾ƒä¸ºç‰¹æ®Šï¼Œå¿…é¡»æ˜¯ UserFacing ç±»å‹
{
  // coding .....
  co_return;
}
```

åæ­£æœ€ç®€å•çš„ç†è§£å°±æ˜¯ï¼Œ**åç¨‹ä¸€å®šæ˜¯éœ€è¦è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°çš„ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°å¿…é¡»è¦ç»™å®ƒæŒ‡å®špromise_type**ã€‚

> ä¸ºä»€ä¹ˆä¸€å®šè¦è®¾è®¡æˆå•ç‹¬è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Ÿ
> å› ä¸ºç¼–è¯‘å™¨å¯¹ promise åšäº†è¯¸å¤šé™åˆ¶ï¼Œä¸” promise æŒæœ‰åç¨‹è¿è¡Œçš„æ•°æ®ï¼Œè€Œé¢å‘ç”¨æˆ·çš„å¯¹è±¡å¯ä»¥è®©ç”¨æˆ·è‡ªå®šä¹‰å¦‚ä½•å»æ“ä½œ promise çš„æ•°æ®ï¼Œæ•°æ®ä¸å¤„ç†é€»è¾‘åˆ†ç¦»å¼€æ¥ç®—æ˜¯è®¾è®¡ä¸Šçš„è§£è€¦ã€‚ ä»åç»­å­¦ä¹ ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°åç¨‹æœ¬èº«æ˜¯éœ€è¦å­˜å‚¨çŠ¶æ€ä»¥åŠæ•°æ®çš„ï¼ŒUserFacing åƒæ˜¯ä¸ºè°ƒç”¨è€…æä¾›äº†ä¸€ä¸ªå…¥å£æ¥æ“çºµåç¨‹ã€‚

#### coroutine_handle

coroutine_handleæ˜¯ä¸€ä¸ªåç¨‹çš„å¥æŸ„ï¼Œæ˜¯ä¸€ä¸ªç±»æ¨¡æ¿`coroutine_handle<promise_type> handle=...`ã€‚é€šè¿‡è¿™ä¸ªhandleå¯ä»¥ï¼š

- **handle.promise()**ã€‚é€šè¿‡è¯¥æ–¹æ³•å¯ä»¥ä»åç¨‹å¥æŸ„è·å– promiseã€‚
- **handle.done()**ã€‚è¯¥æ–¹æ³•ç”¨äºåˆ¤å®šåç¨‹æ˜¯å¦æ‰§è¡Œç»“æŸã€‚
- **handle.resume()**ã€‚è¯¥æ–¹æ³•å¯ä»¥ä½¿æš‚åœçš„åç¨‹ç»§ç»­è¿è¡Œï¼Œæ³¨æ„å¦‚æœæ­¤æ—¶ handle å…³è”çš„åç¨‹æ‰§è¡Œç»“æŸï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šäº§ç”Ÿ core dumpã€‚
- **handle.destroy()**ã€‚è¯¥æ–¹æ³•è´Ÿè´£åç¨‹å¸§å†…å­˜çš„å›æ”¶ï¼Œç”¨æˆ·éœ€è¦é¿å…é‡å¤è°ƒç”¨ã€‚

```
æ³¨æ„,å¯ç›´æ¥ä½¿ç”¨ coroutine_handle<>å³æ¨¡æ¿å‚æ•°é»˜è®¤ä¸ºç©ºï¼Œè¿™ç±»ä¼¼äº void*æŒ‡é’ˆ,å­˜å‚¨ä»»æ„ç±»å‹çš„ promiseã€‚ä½†æ­¤æ—¶æ— æ³•è°ƒç”¨ handle.promise() æ–¹æ³•ï¼Œç”¨æˆ·è‹¥æƒ³è·å–å­˜å‚¨çš„ promise éœ€è¦ä½¿ç”¨ç±»å‹è½¬æ¢ã€‚
```

#### promise

promiseå°±æ˜¯åç¨‹æ ¸å¿ƒçš„æ•°æ®ç»“æ„äº†ï¼Œç”¨æˆ·é€šè¿‡promiseæ¥è®¿é—®ç¼–è¯‘å™¨ä¸ºåç¨‹åˆ†é…çš„å†…å­˜ï¼Œä¹Ÿå¯ä»¥ç”¨promiseå­˜å‚¨åç¨‹è¿è¡Œçš„æ—¶å€™çš„ä¸´æ—¶å€¼ã€‚

##### åç¨‹çš„æ„é€ 

è°ƒç”¨åç¨‹çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šå»æ‰¾è¯¥åç¨‹ç»‘å®šçš„promise_type,ç„¶ååœ¨åç¨‹å¸§ä¸Šå°†promise_typeå¯¹åº”çš„promiseå¯¹è±¡æ„é€ å‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦é€‰å–promiseçš„æ„é€ å‡½æ•°

> å¯ä»¥ä¸º promise ç±»æŒ‡å®šå¤šä¸ªæ„é€ å‡½æ•°.
>
> **C++ åç¨‹è®¾è®¡ä¸ºä½•è¦å°†åç¨‹çš„å‚æ•°åˆ—è¡¨ä¸ promise æ„é€ å‡½æ•°å…³è”èµ·æ¥**ï¼Ÿ å› ä¸ºåç¨‹ä¸ä»…å¯ä»¥æ˜¯æ™®é€šå‡½æ•°ï¼Œè¿˜å¯ä»¥æ˜¯ç±»çš„æˆå‘˜å‡½æ•°ã€‚è¯»è€…åº”è¯¥äº†è§£ C++ ä¸­å¯¹è±¡è°ƒç”¨æˆå‘˜å‡½æ•°éƒ½ä¼šéšå¼çš„ä¼ é€’ this æŒ‡é’ˆï¼Œè€Œåœ¨ç¼–è¯‘å™¨è§†è§’çœ‹æˆå‘˜å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿæ˜¯ç±»æŒ‡é’ˆï¼Œç”¨æˆ·ä¸éœ€è¦æ˜¾å¼çš„æ·»åŠ ã€‚
>
> åŒç†ï¼Œåç¨‹ä½œä¸ºæˆå‘˜å‡½æ•°æ—¶å‚æ•°åˆ—è¡¨ä¹Ÿä¸éœ€è¦æ·»åŠ ç±»æŒ‡é’ˆï¼Œä½†æ­¤æ—¶ç¼–è¯‘å™¨æ„é€ åç¨‹å¯¹è±¡ä¼šä¼ é€’ this æŒ‡é’ˆï¼Œæ‰€ä»¥ promise çš„æ„é€ å‡½æ•°å‚æ•°éœ€è¦å¸¦æœ‰ç±»æŒ‡é’ˆï¼Œè¿™æ ·åç¨‹è¿è¡Œè¿‡ç¨‹ä¸­æ‰å¯ä»¥é€šè¿‡ç±»æŒ‡é’ˆè®¿é—®ç±»æˆå‘˜å’Œæ–¹æ³•ã€‚

##### get_return_object

> ```
> // å‡½æ•°åŸå‹
> UserFacing promise::get_return_object();
> ```

ç”¨æˆ·è°ƒç”¨åç¨‹æ—¶è·å–çš„ UserFacing å¯¹è±¡æ˜¯ç¼–è¯‘å™¨é€šè¿‡ promise çš„ get_return_object å‡½æ•°æ„é€ å‡ºæ¥çš„ï¼Œè¯¥å‡½æ•°å‚æ•°ä¸ºç©ºï¼Œè¿”å›ç±»å‹éœ€è¦ä¸åç¨‹çš„è¿”å›ç±»å‹ä¸€è‡´ã€‚

##### initial_suspend

> ```
> // å‡½æ•°åŸå‹
> awaiter promise::initial_suspend();
> ```

å‰æ–‡æˆ‘ä»¬æåˆ° C++ ä¸ºåç¨‹è®¾è®¡äº†å¤šä¸ªè°ƒåº¦ç‚¹ï¼Œç¬¬ä¸€ä¸ªè°ƒåº¦ç‚¹ä¾¿æ˜¯åœ¨åç¨‹åˆ›å»ºæ—¶ï¼Œç”± initial_suspend æ–¹æ³•å®ç°è°ƒåº¦é€»è¾‘ã€‚æ¯”å¦‚è°ƒç”¨åç¨‹å¹¶æ„é€ å®Œåç¨‹å¸§åï¼Œç¼–è¯‘å™¨å°±ä¼šè°ƒç”¨å’Œåç¨‹ç›¸å…³çš„promiseå¯¹è±¡çš„initial_suspendæ–¹æ³•é€šè¿‡è¿”å›awaiteræ¥å†³å®šæ˜¯ç›´æ¥è¿è¡Œåç¨‹è¿˜æ˜¯æš‚åœæ‰§è¡Œ...

C++ å®˜æ–¹æä¾›äº†é»˜è®¤çš„ awaiter å®ç°ï¼š

- **std::suspend_always**ã€‚æš‚åœåç¨‹æ‰§è¡Œï¼Œæ‰§è¡Œæƒè¿”å›ç»™è°ƒç”¨è€…ã€‚
- **std::suspend_never**ã€‚åç¨‹ç»§ç»­æ‰§è¡Œã€‚

##### final_suspend

ä¸ initial_suspend ç±»ä¼¼ï¼Œfinal_suspend å‡½æ•°è´Ÿè´£åç¨‹æ‰§è¡Œç»“æŸåçš„è°ƒåº¦ç‚¹é€»è¾‘ï¼Œè¿”å›å€¼åŒæ ·æ˜¯ awaiter ç±»å‹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ awaiter æ¥è½¬ç§»æ‰§è¡Œæƒï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿”å› std::suspend_alaways æˆ–è€… std::suspend_neverï¼Œè°ƒç”¨ final_suspend å‡½æ•°æ—¶ä¼šæ‰§è¡Œä¸‹åˆ—ä¼ªä»£ç ï¼š

```
co_await p.final_suspend();
destruct promise p
destruct parameters in coroutine frame
destroy coroutine state
```

æ¢å¥è¯è¯´ï¼Œå¦‚æœ final_suspend è¿”å›äº† suspend_neverï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šæ¥ç€æ‰§è¡Œåç»­çš„èµ„æºæ¸…ç†æ“ä½œï¼Œå¦‚æœ UserFacing åœ¨ææ„å‡½æ•°ä¸­å†æ¬¡æ‰§è¡Œ handle.destroyï¼Œé‚£ä¹ˆä¼šå‡ºç° core dumpï¼Œæ‰€ä»¥ä¸€èˆ¬å»ºè®®ä¸è¦è¿”å› suspend_neverï¼Œå› ä¸ºèµ„æºçš„é‡Šæ”¾æœ€å¥½åœ¨ç”¨æˆ·ä¾§æ¥åšã€‚

##### co_return & return_value

åç¨‹çš„ co_return å°±åƒæ™®é€šå‡½æ•°çš„ return ä¸€æ ·ï¼Œç”¨äºç»ˆæ­¢åç¨‹å¹¶é€‰æ‹©æ€§çš„è¿”å›å€¼ã€‚æ ¹æ® co_return æ˜¯å¦è¿”å›å€¼ï¼Œç¼–è¯‘å™¨ä¼šåšå‡ºä¸åŒçš„å¤„ç†ï¼š

- **ä¸è¿”å›å€¼**ã€‚æ­¤æ—¶ co_return ä»…ç”¨äºç»ˆæ­¢åç¨‹æ‰§è¡Œï¼Œç¼–è¯‘å™¨éšåè°ƒç”¨ promise.return_void æ–¹æ³•ï¼Œæ­¤å‡½æ•°å¯å®ç°ä¸ºç©ºï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿå¯ä»¥æ‰§è¡Œåç¨‹ç»“æŸåçš„æ¸…ç†å·¥ä½œï¼Œä½†ç”¨æˆ·å¿…é¡»ä¸º promise å®šä¹‰ return_void æ–¹æ³•ã€‚
- **è¿”å›å€¼**ã€‚å‡è®¾ co_return è¿”å›å€¼çš„ç±»å‹ä¸º Tï¼Œæ­¤æ—¶ç¼–è¯‘å™¨è°ƒç”¨ promise.return_value æ–¹æ³•ï¼Œå¹¶å°† co_return çš„è¿”å›å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œ**ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ return_value å‡½æ•°çš„å‚æ•°ç±»å‹**ï¼Œå°±åƒè°ƒç”¨æ­£å¸¸å‡½æ•°ä¸€æ ·ï¼Œåªè¦ T å¯ä»¥è½¬æ¢ä¸ºè¯¥å‚æ•°ç±»å‹å³å¯ã€‚æ ·ä¾‹ç¨‹åºä¸­å› ä¸º co_return è¿”å›äº†å€¼ï¼Œæ‰€ä»¥ promise_type ä¹Ÿå¢æ·»äº†ä¸€ä¸ªæˆå‘˜å‡½æ•°ç”¨äºå­˜å‚¨è¯¥å€¼ï¼Œåœ¨ return_value å‡½æ•°ä½“å†…å®Œæˆèµ‹å€¼ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ C++ æ ‡å‡†è§„å®š return_value å’Œ return_void å‡½æ•°ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼Œå¹¶ä¸”å½“åç¨‹ä¸å­˜åœ¨ co_return å…³é”®å­—æ—¶ç”¨æˆ·ä¹Ÿéœ€è¦å®šä¹‰ return_void æ–¹æ³•ï¼Œå› ä¸ºåç¨‹æ‰§è¡Œç»“æŸåç¼–è¯‘å™¨ä¼šéšå¼è°ƒç”¨è¯¥å‡½æ•°ã€‚

> éœ€è¦å…³æ³¨çš„ä¸€ç‚¹æ˜¯ï¼Œåç¨‹å‡½æ•°å’Œæ™®é€šå‡½æ•°çš„è¿”å›å€¼å¤„ç†ä¸ä¸€æ ·ï¼Œæ™®é€šå‡½æ•°å°±æ˜¯è¿”å›å€¼æ‰€ä»¥å¯ä»¥ç›´æ¥æ¸ é“ï¼Œåç¨‹å‡½æ•°å¯¹äºè°ƒç”¨æ–¹æ¥è¯´è¿”å›çš„æ˜¯UserFacingå¯¹è±¡ï¼Œé‚£ä¹ˆæ€ä¹ˆæ‹¿åˆ°co_returnçš„å€¼ï¼Ÿä¸€èˆ¬çš„é€»è¾‘æ˜¯åœ¨ promise ä¸­å¢åŠ ä¸€ä¸ªæˆå‘˜å˜é‡å¹¶åœ¨ return_value å‡½æ•°ä¸­ä¸ºå…¶èµ‹å€¼ï¼Œco_return ååç¨‹æ‰§è¡Œç¡®å®ç»“æŸäº†ï¼Œä½†åç¨‹å¸§å¹¶ä¸ä¼šè‡ªåŠ¨å›æ”¶ï¼Œpromise å¯¹è±¡ä¾ç„¶å­˜åœ¨ï¼Œç”¨æˆ·å¯ä»¥åœ¨ UserFacing ä¸­æ·»åŠ è·å–è¯¥å€¼çš„æ–¹æ³•ï¼ŒUserFacing ä¸€èˆ¬å­˜å‚¨äº† promise çš„ coroutine_handleï¼Œé€šè¿‡è¯¥ handle è®¿é—® promise çš„æˆå‘˜å˜é‡ã€‚

##### co_yield & yield_value

> ```
> // å‡½æ•°åŸå‹
> co_yield T;
> awaiter promise::yield_value(T);
> ```

co_yield ç”¨äºåç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘å¤–è¾“å‡ºå€¼ã€‚ä¸ co_return ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨ promise ä¸­ä¸ºå…¶æ–°å¢æˆå‘˜å˜é‡ï¼Œå½“æ‰§è¡Œåˆ° co_yield è¯­å¥æ—¶ï¼Œç¼–è¯‘å™¨è°ƒç”¨ yield_value æ–¹æ³•ï¼Œco_yield çš„å€¼ä½œä¸ºå‚æ•°ï¼Œå‡½æ•°ä½“å†…å°†è¯¥å€¼èµ‹äºˆç»™ promise æˆå‘˜å˜é‡ã€‚å¤–éƒ¨è®¿é—®è¯¥ co_yield çš„å€¼çš„æµç¨‹ä¸ co_return ç±»ä¼¼ã€‚

ä¸ co_return ä¸åŒçš„æ˜¯ï¼Œco_yield ä¹‹ååç¨‹çš„è¿è¡Œå¹¶ä¸ä¸€å®šç»“æŸï¼Œæ‰€ä»¥ yield_value é€šè¿‡è¿”å› awaiter ç±»å‹æ¥å†³å®šåç¨‹çš„æ‰§è¡Œæƒå¦‚ä½•å¤„ç†ï¼Œä¸€èˆ¬è¿”å› std::suspend_alaways è½¬ç§»æ§åˆ¶æƒåˆ°è°ƒç”¨è€…ï¼Œç”¨æˆ·ä¹Ÿå¯è¿”å›è‡ªå®šä¹‰çš„ awaiterï¼Œä½†é€šå¸¸ä¸è¦è¿”å› std::suspend_never ç­‰è®©åç¨‹ç»§ç»­è¿è¡Œçš„ awaiterï¼Œå› ä¸ºæ­¤æ—¶åç¨‹ç»§ç»­è¿è¡Œçš„è¯å¦‚æœå†æ¬¡ç¢°åˆ° co_yield é‚£ä¹ˆä¸Šæ¬¡ yield çš„å€¼å°±ä¼šè¢«è¦†ç›–ã€‚

##### unhandled_exception

> ```
> // å‡½æ•°åŸå‹
> void promise::unhandled_exception();
> ```

å¦‚æœåç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºäº†å¼‚å¸¸ä¸”æ²¡æœ‰æ•è·ï¼Œé‚£ä¹ˆåç¨‹çš„è¿è¡Œä¼šæå‰ç»ˆæ­¢ï¼Œä¸”æ— æ³•é€šè¿‡ coroutine_handle æ¢å¤åç¨‹ã€‚æ­¤æ—¶ç¼–è¯‘å™¨è°ƒç”¨ promise çš„ unhandled_exception æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œæˆ‘ä»¬é€šå¸¸å®ç°è¯¥å‡½æ•°ä¸ºåˆ©ç”¨æ ‡å‡†åº“æä¾›çš„ std::current_exception æ–¹æ³•è·å–å½“å‰å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå¹¶å°†å¼‚å¸¸ä½œä¸ºå˜é‡å­˜å‚¨ï¼Œæ³¨æ„å¼‚å¸¸ä¸ä¼šå†å‘ä¸Šä¼ æ’­ã€‚æ­¤æ—¶æ§åˆ¶æƒè½¬ç§»åˆ°åç¨‹è°ƒç”¨è€…ï¼Œç”¨æˆ·å¯ä»¥åœ¨ UserFacing çš„æ–¹æ³•ä¸­è·å–å­˜å‚¨çš„å¼‚å¸¸ï¼Œå¹¶å†æ¬¡æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æ ·ä¾‹ç¨‹åºä¸­ Task çš„ next æ–¹æ³•æ‰€ç¤ºã€‚

>  **ğŸ’¡ä¸ºä½•æ™®é€šå‡½æ•°åœ¨æŠ›å‡ºå¼‚å¸¸æœªæ•è·åå¼‚å¸¸ä¼šä¸€ç›´å‘ä¸Šä¼ é€’ç›´åˆ°è¢«æ•è·ï¼Œè€Œåç¨‹æŠ›å‡ºå¼‚å¸¸æœªæ•è·å´å¹¶ä¸ä¼šå‘ä¸Šä¼ é€’ï¼Ÿ** C++ åç¨‹å…³äºå¼‚å¸¸å¤„ç†çš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬éšå¼çš„æ·»åŠ äº† try/catch è¯­å¥ï¼Œå› æ­¤å¼‚å¸¸å¹¶ä¸ä¼šä¼ æ’­åˆ°è°ƒç”¨è€…ã€‚ç»¼åˆæ¥çœ‹ C++ åç¨‹çš„è®¾è®¡è€…é€šè¿‡ unhandled_exception ä½¿å¾—åç¨‹çš„å¼‚å¸¸å¤„ç†æ›´åŠ çµæ´»ã€‚

```
try{
 // coroutine body
} catch {
 promise.unhandled_exception();
}
```

#### awaiter

åˆšæ‰è¯´çš„åç¨‹è®¾è®¡äº†å¤šç§ç±»å‹è°ƒåº¦ç‚¹ï¼Œè¿™æ˜¯è°ƒåº¦ç‚¹çš„é€»è¾‘éƒ½éœ€è¦åœ¨awaiteré‡Œé¢å®ç°ã€‚C++ åç¨‹æ ‡å‡†è¦æ±‚ awaiter å¿…é¡»å®ç°ä¸‹åˆ—ä¸‰ä¸ªæ–¹æ³•ï¼š

- **await_ready**
- **await_suspend**
- **await_resume**

# é¡¹ç›®

## å°è£…taskåŸºæœ¬ä»»åŠ¡å•å…ƒ

`task<T>` æ˜¯ tinyCoro çš„**åç¨‹ä»»åŠ¡åŸºæœ¬å•å…ƒ**ï¼Œæ‰¿æ‹…ä¸¤ä»¶äº‹ï¼š

1. **è°ƒåº¦å•å…ƒ**ï¼šæŠŠåç¨‹å¥æŸ„äº¤ç»™å¼•æ“ï¼ˆengineï¼‰ç»Ÿä¸€è°ƒåº¦æ‰§è¡Œï¼›
2. **èµ„æºæ‰€æœ‰è€…**ï¼ˆå¯è½¬ç§»ï¼‰ï¼šé»˜è®¤ç”± `task` ææ„é‡Šæ”¾åç¨‹å¸§ï¼›å³å€¼æäº¤å `detach()`ï¼ŒæŠŠé‡Šæ”¾è´£ä»»è½¬ç§»ç»™ engine çš„ `clean()`ã€‚

**ä¸ç¼–è¯‘å™¨/åç¨‹è¯­ä¹‰çš„è¡”æ¥**

- å‡½æ•°å£°æ˜ä¸º `task<T> f(...)` â†’ ç¼–è¯‘å™¨å°†å…¶è§†ä¸ºåç¨‹ï¼ˆå› å­˜åœ¨ `promise_type`ï¼‰ã€‚
- åç¨‹åˆ›å»ºæµç¨‹ï¼šåˆ†é…åç¨‹å¸§ â†’ æ„é€  `promise` â†’ `get_return_object()` è¿”å› `task`ï¼ˆå†…éƒ¨æŒæœ‰ `coroutine_handle`ï¼‰ â†’ è°ƒç”¨ `initial_suspend()`ã€‚
- **è®¾è®¡è¦ç‚¹**ï¼š`initial_suspend() == std::suspend_always`ï¼Œåˆ›å»ºå³æŒ‚èµ·ï¼Œ**å¿…é¡»**äº¤ç»™å¼•æ“å¯åŠ¨ï¼Œç¡®ä¿è°ƒåº¦å¯æ§ã€‚

**è°ƒåº¦æ¨¡å‹ï¼ˆçˆ¶å­æ¥åŠ› + å¯¹ç§°ç§»äº¤ï¼‰**

**çˆ¶åç¨‹ `co_await` å­åç¨‹ï¼ˆ`task` è‡ªå¸¦ awaiterï¼‰**

```
auto await_suspend(std::coroutine_handle<> parent) noexcept
  -> std::coroutine_handle<> {
  m_coroutine.promise().m_continuation = parent; // è®°å½•çˆ¶å¥æŸ„
  return m_coroutine;                            // ç«‹åˆ»è½¬å»æ‰§è¡Œâ€œå­â€ï¼ˆå¯¹ç§°ç§»äº¤ï¼‰
}
```

**å­åç¨‹ç»“æŸ â†’ äº¤è¿˜æ‰§è¡Œæƒç»™çˆ¶ï¼ˆ`final_suspend()`ï¼‰**

```
struct FinalAwaiter {
  bool await_ready() noexcept { return false; }
  template <typename P>
  void await_suspend(std::coroutine_handle<P> child) noexcept {
    auto& base = static_cast<promise_base&>(child.promise());
    if (base.m_continuation) base.m_continuation.resume(); // æ¢å¤çˆ¶
  }
  void await_resume() noexcept {}
};

auto promise_base::final_suspend() noexcept { return FinalAwaiter{}; }
```

- å­åœ¨ `final_suspend` é˜¶æ®µ**å…ˆå”¤é†’çˆ¶**ï¼›
- å¼•æ“éšåçœ‹åˆ° `done()==true`ï¼Œå†å†³å®šæ˜¯å¦é‡Šæ”¾å­åç¨‹å¸§ï¼ˆè§ä¸‹èŠ‚â€œæ‰€æœ‰æƒè½¬ç§»â€ï¼‰ã€‚

**æ‰€æœ‰æƒä¸ `detach()`/`clean()` åè®®**

**ä¸ºä»€ä¹ˆ `detach()` èƒ½æŠŠé”€æ¯æƒäº¤ç»™ engine**

- `task::detach()` ä¸¤æ­¥ï¼š
  1. åœ¨ `promise` æ‰“æ ‡ `m_detached = true`ï¼›
  2. æ¸…ç©º `task` å†…éƒ¨å¥æŸ„ â†’ `task` ææ„æ—¶ä¸å† destroyã€‚
- å¼•æ“åœ¨æ‰§è¡Œå¾ªç¯ï¼š

```
auto engine::exec_one_task() noexcept -> void {
  auto h = schedule();     // å‡ºé˜Ÿ
  h.resume();              // è¿è¡Œï¼ˆå¯èƒ½ä¸€è·¯åˆ° final_suspendï¼‰
  if (h.done()) clean(h);  // ç”± clean å†³å®šæ˜¯å¦é”€æ¯
}
```

- å…¨å±€ `clean()`ï¼š

```
inline void clean(std::coroutine_handle<> h) noexcept {
  auto typed = std::coroutine_handle<promise_base>::from_address(h.address());
  if (typed.promise().is_detached()) typed.destroy(); // ä»… detached æ‰ç”±å¼•æ“é”€æ¯
}
```

**æäº¤æµç¨‹ï¼ˆå³å€¼ï¼‰**

```
// scheduler ç«¯
auto handle = task.handle();  // å¤åˆ¶å¥æŸ„ï¼ˆæŒ‡å‘åŒä¸€å¸§ï¼‰
task.detach();                // æ ‡è®° detached + æ¸…ç©º task å¥æŸ„
submit(handle);               // äº¤ç»™ context/engine å…¥é˜Ÿ
```

> å¥æŸ„å¯å¤åˆ¶ï¼›å¼•æ“æŒæœ‰çš„é‚£ä»½ä¸€ç›´æœ‰æ•ˆã€‚ä¹‹åé”€æ¯å®Œå…¨ç”±å¼•æ“æŒæ§ã€‚

### æ€»ç»“

â€œæˆ‘ä»¬æŠŠåç¨‹å°è£…æˆ `task` ä½œä¸ºè°ƒåº¦å•å…ƒã€‚åˆ›å»ºå³æŒ‚èµ·ï¼Œç»Ÿä¸€ç”±å¼•æ“è°ƒåº¦ã€‚`co_await` å­ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬åœ¨ awaiter é‡Œè®°å½•çˆ¶å¥æŸ„å¹¶è¿”å›å­å¥æŸ„å®ç°**å¯¹ç§°ç§»äº¤**ï¼Œå­åœ¨ `final_suspend` ä¸­**å…ˆæ¢å¤çˆ¶**ã€‚å³å€¼æäº¤ä¼š `detach()`ï¼ŒæŠŠåç¨‹å¸§çš„é”€æ¯æƒç§»äº¤ç»™å¼•æ“ï¼›å¼•æ“åœ¨ `done()` å `clean()` åªé”€æ¯ **detached** åç¨‹ï¼Œé¿å…åŒåˆ ã€‚I/O å®Œæˆå›è°ƒä»…éœ€æŠŠå¥æŸ„ `submit_to_context` å›å¼•æ“å³å¯æ¢å¤åç¨‹ï¼Œé“¾è·¯æ¸…æ™°è€Œé«˜æ•ˆã€‚

## engineå¼•æ“éƒ¨åˆ†

è§’è‰²å®šä½

`engine` æ˜¯æ¯ä¸ª `context` çº¿ç¨‹å†…çš„æ‰§è¡Œå†…æ ¸ï¼š

- ç»´æŠ¤ä¸€ä¸ª**ä»»åŠ¡é˜Ÿåˆ—**ï¼ˆä¿å­˜ `std::coroutine_handle<>`ï¼‰ï¼›
- é©±åŠ¨ **io_uring + eventfd** åšå¼‚æ­¥ I/Oï¼ˆæäº¤ SQEã€é˜»å¡ç­‰å¾…ã€å¤„ç† CQEï¼‰ï¼›
- çº¦å®šï¼š**ä»»åŠ¡å…¥é˜Ÿå¯è·¨çº¿ç¨‹**ï¼Œio_uring çš„ submit/poll å¿…é¡»åœ¨**æ‰€å±çº¿ç¨‹**è°ƒç”¨ã€‚

å…³é”®æˆå‘˜ï¼ˆä¸ä½ çš„ä»£ç ä¸€è‡´ï¼‰

```
uint32_t    m_id;
uring_proxy m_upxy;                    // liburing äºŒæ¬¡å°è£…ï¼Œç»‘å®š eventfd
mpmc_queue<std::coroutine_handle<>> m_task_queue; // AtomicQueueï¼Œæ— é” MPMC
std::array<urcptr, config::kQueCap> m_urc;        // æ‰¹é‡å– CQE çš„æš‚å­˜
std::atomic<int> m_num_io_wait_submit{0};         // å¾…æäº¤ SQE æ•°
std::atomic<int> m_num_io_running{0};             // å·²æäº¤æœªå®Œæˆ IO æ•°
```

ç”Ÿå‘½å‘¨æœŸ API

init / deinit

```
auto engine::init() noexcept -> void {
    m_upxy.init(config::kEntryLength);
    linfo.egn = this;           // TLS ç»‘å®šï¼šlocal_engine() å¯ç”¨
    m_num_io_wait_submit = 0;
    m_num_io_running     = 0;
}

auto engine::deinit() noexcept -> void {
    m_upxy.deinit();
    mpmc_queue<coroutine_handle<>> q;  // æ¸…ç©ºä»»åŠ¡é˜Ÿåˆ—
    m_task_queue.swap(q);
    m_num_io_wait_submit = 0;
    m_num_io_running     = 0;
}
```

ä»»åŠ¡è°ƒåº¦ç›¸å…³

æäº¤ & å”¤é†’

```
auto engine::submit_task(coroutine_handle<> h) noexcept -> void {
    m_task_queue.push(h);   // å¯è·¨çº¿ç¨‹ç”Ÿäº§
    wake_up(1);             // å†™ eventfdï¼Œå”¤é†’é˜»å¡åœ¨ wait_eventfd() çš„å·¥ä½œçº¿ç¨‹
}

auto engine::wake_up(uint64_t val) noexcept -> void {
    m_upxy.write_eventfd(val);
}
```

é˜Ÿåˆ—çŠ¶æ€ä¸è·å–

```
auto engine::ready() noexcept -> bool        { return !m_task_queue.was_empty(); }
auto engine::num_task_schedule() noexcept -> size_t { return m_task_queue.was_size(); }
auto engine::schedule() noexcept -> coroutine_handle<> {
    auto h = m_task_queue.pop();   // æœ¬çº¿ç¨‹æ¶ˆè´¹
    assert(bool(h));
    return h;
}
```

æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼ˆå«æ¸…ç† detached åç¨‹å¸§ï¼‰

```
auto engine::exec_one_task() noexcept -> void {
    auto coro = schedule();
    coro.resume();
    if (coro.done()) { clean(coro); } // clean() åªé”€æ¯å·² detach çš„åç¨‹ï¼ˆè§ task.hppï¼‰
}
```

I/O æ”¯æŒï¼ˆä¸ awaiter çš„å¥‘çº¦ï¼‰

awaiter ä¾§ï¼ˆè¦ç‚¹ï¼‰

- æ„é€ æ—¶ï¼š`local_engine().get_free_urs()` å– SQE â†’ `io_uring_prep_XXX(...)` â†’ `io_uring_sqe_set_data(sqe, &io_info)` â†’ `local_engine().add_io_submit()`
- `await_suspend`ï¼šè®°å½•å½“å‰åç¨‹å¥æŸ„åˆ° `io_info.handle`ï¼Œåç¨‹æŒ‚èµ·
- å®Œæˆæ—¶ï¼šCQE â†’ `engine::handle_cqe_entry(cqe)` å–å› `io_info` â†’ `io_info.cb(data, res)` å›è°ƒé‡Œ `submit_to_context(io_info->handle)`

engine ä¾§æ¥å£

```
auto engine::get_free_urs() noexcept -> ursptr {
    return m_upxy.get_free_sqe();
}

auto engine::add_io_submit() noexcept -> void {
    m_num_io_wait_submit += 1;      // åªè®¡æ•°ï¼Œä¸è·¨çº¿ç¨‹è§¦å‘ submit
}

auto engine::handle_cqe_entry(urcptr cqe) noexcept -> void {
    auto data = reinterpret_cast<io::detail::io_info*>(io_uring_cqe_get_data(cqe));
    data->cb(data, cqe->res);       // å›è°ƒé‡ŒæŠŠåç¨‹å¥æŸ„æŠ•å› context/engine
}
```

I/O å¿ƒè·³ï¼špoll_submitï¼ˆ**ä½ çš„å®ç°é€»è¾‘**ï¼‰

```
auto engine::poll_submit() noexcept -> void {
    if (m_num_io_wait_submit > 0) {
        [[maybe_unused]] auto _ = m_upxy.submit();   // ä¸€æ¬¡æ€§æäº¤å…¨éƒ¨å¾…æäº¤ SQE
        m_num_io_running += m_num_io_wait_submit;    // è¿ç§»åˆ° inflight
        m_num_io_wait_submit = 0;
    }

    m_upxy.wait_eventfd();                           // é˜»å¡ç›´è‡³æœ‰äº‹ä»¶ï¼ˆCQE æˆ–å¤–éƒ¨å”¤é†’ï¼‰

    int n_cqe = m_upxy.peek_batch_cqe(
        m_urc.data(),
        m_num_io_running.load(std::memory_order_acquire)
    );

    if (n_cqe > 0) {
        for (int i = 0; i < n_cqe; ++i) handle_cqe_entry(m_urc[i]);
        m_upxy.cq_advance(n_cqe);
        m_num_io_running.fetch_sub(n_cqe, std::memory_order_zacq_rel);
    }
}**è¯´æ˜**
```

- `wait_eventfd()` æ˜¯**ç¡çœ ç‚¹**ï¼šæ²¡æœ‰ä»»åŠ¡/IO å¯å¤„ç†æ—¶ï¼Œçº¿ç¨‹åœ¨è¿™é‡Œä¼‘çœ ï¼›
   å”¤é†’æºåŒ…æ‹¬ï¼š
  1. I/O çœŸçš„å®Œæˆï¼ˆå†…æ ¸å‘ eventfd å†™ï¼‰ï¼›
  2. æ–°ä»»åŠ¡æäº¤ï¼ˆ`submit_task()` é‡Œ `wake_up(1)`ï¼‰ï¼›
  3. ä¸Šå±‚åœæ­¢/å¤–éƒ¨é€šçŸ¥ï¼ˆä¾‹å¦‚ `context::notify_stop()` è°ƒ `engine.wake_up(1)`ï¼‰ã€‚
- `peek_batch_cqe(...)` æŒ‰å½“å‰ `m_num_io_running` çš„ä¸Šé™æ‰¹é‡å– CQEï¼›eventfd çš„å€¼**ä¸æ˜¯å®Œæˆæ•°**ï¼Œåªä»£è¡¨â€œæœ‰äº‹ä»¶â€ã€‚

I/O æ˜¯å¦ä¸ºç©º

```
auto engine::empty_io() noexcept -> bool {
    return m_num_io_wait_submit == 0 && m_num_io_running == 0;
}
```

ä¸ context::run çš„åä½œï¼ˆæŒ‰ä½ å½“å‰ä»£ç ï¼‰

ä½ çš„ `context::run(stop_token)` é€»è¾‘ï¼š

```
while (!token.stop_requested()) {
    // â‘  æ‰¹é‡æŠŠé˜Ÿåˆ—é‡Œâ€œç°æœ‰â€çš„è®¡ç®—ä»»åŠ¡è·‘å®Œ
    auto num = m_engine.num_task_schedule();
    for (int i = 0; i < num; ++i) {
        m_engine.exec_one_task();
    }

    // â‘¡ å¦‚æœæ—¢æ²¡æœ‰åœ¨é£ IO/å¾…æäº¤ IOï¼Œä¹Ÿæ²¡æœ‰æŒ‚èµ·ç­‰å¾…è®¡æ•°
    if (empty_wait_task()) {
        if (!m_engine.ready()) {    // ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿç©ºäº†
            m_stop_cb();            // è§¦å‘å¤–éƒ¨çš„åœæ­¢ï¼ˆå• context æ¨¡å¼ä¸‹å¯è‡ªåœï¼‰
        } else {
            continue;               // è¿˜æœ‰ä»»åŠ¡å°±å›åˆ°ä¸‹ä¸€è½®
        }
    }

    // â‘¢ ä¸ç®¡æœ‰æ²¡æœ‰ IOï¼Œè¿™é‡Œéƒ½ä¼šè¿›å…¥ poll_submit()
    //    è‹¥ç¡®å®æ—  IOï¼Œä¼šåœ¨ wait_eventfd() ç¡çœ ï¼Œç›´åˆ°è¢«æ–°ä»»åŠ¡æˆ– IO å®Œæˆå”¤é†’
    m_engine.poll_submit();
}
```

**è¦ç‚¹**

- ä½ çš„è®¾è®¡æ˜¯**æ¯è½®éƒ½è°ƒç”¨ `poll_submit()`**ï¼›å€ŸåŠ© eventfdï¼Œè®©çº¿ç¨‹åœ¨ç©ºé—²æ—¶â€œç¡ç€â€ï¼Œæ–°ä»»åŠ¡/IO å®Œæˆ/åœæ­¢ä¿¡å·éƒ½ä¼šæŠŠå®ƒâ€œå«é†’â€ã€‚
- `notify_stop()` é‡Œä¼š `m_job->request_stop(); m_engine.wake_up(1);`ï¼Œç¡®ä¿ä¸ç¡æ­»åœ¨ `wait_eventfd()`ã€‚

çº¿ç¨‹æ¨¡å‹

- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šMPMCï¼ˆä»»ä½•çº¿ç¨‹éƒ½å¯ `push`ï¼‰ï¼Œæœ¬ context çº¿ç¨‹ `pop`ï¼›
- **io_uring**ï¼šåªå…è®¸æœ¬ context çº¿ç¨‹ `submit()/wait/peek`ï¼›
- **è®¡æ•°å™¨**ï¼šåŸå­è¯»å†™ï¼ˆè¿™é‡Œç”¨ `+=`/`fetch_sub`ï¼Œä¸æäº¤/å®Œæˆçš„ç¨‹åºæ¬¡åºä¸€è‡´å³å¯ï¼‰ã€‚

ä¸å˜é‡ä¸è‡ªæ£€

- `init()` è¦è®¾ç½® `linfo.egn = this`ï¼Œ`deinit()` è¦å½»åº•æ¸…ç†é˜Ÿåˆ—ä¸è®¡æ•°ï¼›
- `submit_task()` ä¸€å®šè¦ `wake_up(1)`ï¼Œå¦åˆ™å¯èƒ½ç¡æ­»åœ¨ `wait_eventfd()`ï¼›
- `poll_submit()`ï¼š
  - å…ˆæŠŠ `m_num_io_wait_submit` å…¨éƒ¨ `submit()` åˆ°å†…æ ¸ï¼Œå¹¶è¿ç§»åˆ° `m_num_io_running`ï¼›
  - `wait_eventfd()` å**ä¸€å®š**åš `peek_batch_cqe()` + `cq_advance(n)` + `m_num_io_running -= n`ï¼›
- `exec_one_task()`ï¼š`done()` åè°ƒç”¨ `clean()`ï¼›**åªé‡Šæ”¾ detached** åç¨‹å¸§ï¼ˆé…åˆ `task::detach()` åè®®ï¼‰ã€‚

å¸¸è§é—®ç­”ï¼ˆåŸºäºæ­¤å®ç°ï¼‰

- **Qï¼šä¸ºä»€ä¹ˆä»»åŠ¡æäº¤è¦å†™ eventfdï¼Ÿ**
   Aï¼šå› ä¸º `poll_submit()` æ€»ä¼š `wait_eventfd()` ä½œä¸ºç¡çœ ç‚¹ï¼›æ–°ä»»åŠ¡åˆ°æ¥å¿…é¡»æŠŠçº¿ç¨‹å”¤é†’ï¼Œå¦åˆ™è¦ç­‰åˆ°ä¸‹ä¸€æ¬¡ IO å®Œæˆæ‰é†’ã€‚
- **Qï¼š`wait_eventfd()` ä¼šä¸ä¼šå¯¼è‡´â€œæœ‰ä»»åŠ¡å´ä¸æ‰§è¡Œâ€ï¼Ÿ**
   Aï¼šä¸ä¼šã€‚æ–°ä»»åŠ¡æäº¤è·¯å¾„é‡Œä¼š `wake_up(1)`ï¼›è¿™ä¼šç«‹å³å”¤é†’ `poll_submit()` ç»§ç»­å¾ªç¯ï¼Œä¸‹ä¸€è½®å…ˆè·‘æ‰¹é‡ä»»åŠ¡ã€‚
- **Qï¼šå¦‚æœæ²¡æœ‰ä»»ä½• IOï¼Œè¿™æ ·æ¯è½® `poll_submit()` ä¼šä¸ä¼šç™½ç­‰ï¼Ÿ**
   Aï¼šæ˜¯**åˆ»æ„è®¾è®¡**çš„â€œç»Ÿä¸€ç¡çœ ç‚¹â€ã€‚æ—  IO æ—¶ `wait_eventfd()` ä¼šç¡ç€ï¼Œç›´åˆ°**æ–°ä»»åŠ¡/åœæ­¢ä¿¡å·**å”¤é†’ï¼Œçº¿ç¨‹å¤„äºé«˜æ•ˆä¼‘çœ çŠ¶æ€ã€‚

### æ€»ç»“

â€œengine ç”¨ `AtomicQueue` å­˜åç¨‹å¥æŸ„ï¼Œ`submit_task` å…¥é˜Ÿå¹¶å†™ eventfd å”¤é†’çº¿ç¨‹ï¼›çº¿ç¨‹å¾ªç¯æ¯è½®å…ˆæŠŠç°æœ‰ä»»åŠ¡æ‰¹é‡ `resume` å®Œï¼Œå†è¿› `poll_submit`ï¼šæŠŠå¾…æäº¤ SQE å…¨éƒ¨ `submit`ï¼Œé˜»å¡ `wait_eventfd`ï¼Œè¢« IO å®Œæˆæˆ–æ–°ä»»åŠ¡/åœæ­¢ä¿¡å·å”¤é†’åç”¨ `peek_batch_cqe` å¤„ç†å®Œæˆé¡¹å¹¶æŠŠå¯¹åº”åç¨‹é‡æ–°æŠ•å›é˜Ÿåˆ—ã€‚åç¨‹ `done()` åç”± `clean()` é‡Šæ”¾ä»… `detached` çš„å¸§ï¼Œå’Œ `task::detach()` åè®®å¯¹é½ã€‚â€

## context éƒ¨åˆ†

## Contextï¼šæ¯ä¸ªå·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œå®¹å™¨

### è§’è‰²ä¸æˆå‘˜

- **èŒè´£**ï¼šä¸ºæ¯ä¸ªå·¥ä½œçº¿ç¨‹æä¾›è¿è¡Œå¾ªç¯ï¼Œé©±åŠ¨å…¶ç§æœ‰çš„ `engine` æ‰§è¡Œ**è®¡ç®—ä»»åŠ¡**ä¸**å¼‚æ­¥ I/O**ï¼Œå¹¶è´Ÿè´£**åœæ­¢åè®®**ä¸**æŒ‚èµ·å¼•ç”¨è®¡æ•°**ã€‚

- **å…³é”®æˆå‘˜**

  ```
  CORO_ALIGN engine   m_engine;            // çº¿ç¨‹ç§æœ‰ engine
  std::unique_ptr<std::jthread> m_job;     // å·¥ä½œçº¿ç¨‹ï¼ˆC++20ï¼Œè‡ªåŠ¨ joinï¼‰
  ctx_id              m_id;                // å”¯ä¸€ id
  
  // åœæ­¢/è‡ªåœå›è°ƒï¼ˆå¯è¢« scheduler æ³¨å…¥ï¼‰
  using stop_cb = std::function<void()>;
  stop_cb            m_stop_cb;
  
  // â€œæŒ‚èµ·å¼•ç”¨è®¡æ•°â€ï¼šé˜²æ­¢æœ‰åç¨‹æŒ‚èµ·æ—¶æå‰é€€å‡º
  std::atomic<int>   m_wait_cnt{0};
  
  // ç©ºé—²ç­‰å¾…ä½¿ç”¨ï¼ˆå¯ä¸ eventfd å”¤é†’é…åˆï¼‰
  std::condition_variable_any m_cva;
  std::mutex                  m_mtx;
  ```

### ç”Ÿå‘½å‘¨æœŸä¸å¯¹å¤– API

- **init / deinit**

  ```
  auto context::init() noexcept -> void {
      linfo.ctx = this;       // TLS ç»‘å®šï¼šlocal_context() å¯ç”¨
      m_engine.init();        // ç»‘å®š engine åˆ° TLS: linfo.egn
      m_wait_cnt.store(0, std::memory_order_relaxed);
  }
  
  auto context::deinit() noexcept -> void {
      m_engine.deinit();
      m_wait_cnt = 0;
  }
  ```

- **start / notify_stop / join**

  ```
  auto context::start() noexcept -> void {
      m_job = make_unique<jthread>(
        [this](stop_token token) {
          this->init();
          if (!this->m_stop_cb) {
            // å• context åœºæ™¯ç¼ºçœè‡ªåœç­–ç•¥ï¼šè¯·æ±‚è‡ªèº«çº¿ç¨‹åœæ­¢
            m_stop_cb = [&]{ m_job->request_stop(); };
          }
          this->run(token);   // æ ¸å¿ƒå¾ªç¯
          this->deinit();
        });
  }
  
  auto context::notify_stop() noexcept -> void {
      if (m_job) m_job->request_stop(); // é€šè¿‡ stop_token å‘åœæ­¢ä¿¡å·
      m_engine.wake_up(1);              // å†™ eventfdï¼Œå”¤é†’ poll_submit() çš„é˜»å¡
  }
  
  inline auto join() noexcept -> void { m_job->join(); }
  ```

- **ä»»åŠ¡æäº¤**

  ```
  // å³å€¼ï¼šå–å¥æŸ„ -> detach -> è½¬äº¤åˆ°å½“å‰ context çš„ engine
  inline auto submit_task(task<void>&& t) noexcept -> void {
      auto h = t.handle(); t.detach(); submit_task(h);
  }
  // å·¦å€¼ï¼šç›´æ¥è½¬äº¤å¥æŸ„
  inline auto submit_task(task<void>& t) noexcept -> void { submit_task(t.handle()); }
  
  // æ ¸å¿ƒè½¬å‘
  auto context::submit_task(std::coroutine_handle<> h) noexcept -> void {
      m_engine.submit_task(h);  // å…¥é˜Ÿå¹¶å†™ eventfd å”¤é†’
  }
  ```

- **æŒ‚èµ·å¼•ç”¨è®¡æ•°ï¼ˆç­‰å¾…ä¸­çš„åç¨‹ä¿æŠ¤ï¼‰**

  ```
  auto register_wait(int n = 1) noexcept   -> void { m_wait_cnt.fetch_add(n, std::memory_order_acq_rel); }
  auto unregister_wait(int n = 1) noexcept -> void { m_wait_cnt.fetch_sub(n, std::memory_order_acq_rel); }
  
  // æ—  I/O ä¸”æ— ç­‰å¾…åç¨‹
  auto empty_wait_task() noexcept -> bool {
      return m_engine.empty_io() && (m_wait_cnt.load(std::memory_order_acquire) == 0);
  }
  ```

### æ ¸å¿ƒå¾ªç¯ï¼š`run(stop_token token)`

> ä½ çš„å®ç°é‡‡ç”¨â€œ**æ¯è½®æ‰¹é‡è·‘å®Œå½“å‰é˜Ÿåˆ—å†…çš„è®¡ç®—ä»»åŠ¡**ï¼Œéšåç»Ÿä¸€è¿›å…¥ `poll_submit()` ä½œä¸º**ç¡çœ ç‚¹**ï¼ˆeventfd å”¤é†’ï¼‰â€çš„æ¨¡å¼ã€‚

```
auto context::run(stop_token token) noexcept -> void {
    while (!token.stop_requested()) {

        // 1) æ‰¹é‡æ‰§è¡Œâ€œæ­¤æ—¶æ­¤åˆ»â€é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
        auto num = m_engine.num_task_schedule();
        for (int i = 0; i < num; ++i) {
            m_engine.exec_one_task(); // resume -> è‹¥ done åˆ™ clean(detached)
        }

        // 2) è‡ªåœåˆ¤æ–­ï¼ˆå• context å…œåº•ï¼‰
        if (empty_wait_task()) {
            if (!m_engine.ready()) {
                m_stop_cb();          // æ— ä»»åŠ¡ã€æ—  I/Oã€æ— ç­‰å¾… -> è§¦å‘åœæ­¢ç­–ç•¥
            } else {
                continue;             // è¿˜æœ‰ä»»åŠ¡ï¼Œå›åˆ°ä¸‹ä¸€è½®
            }
        }

        // 3) I/O å¿ƒè·³ï¼ˆä¹Ÿä½œä¸ºç»Ÿä¸€ç¡çœ ç‚¹ï¼‰
        //    - æœ‰å¾…æäº¤ I/O: submit()
        //    - wait_eventfd() é˜»å¡ï¼Œç›´åˆ° I/O å®Œæˆ / æ–°ä»»åŠ¡å”¤é†’ / åœæ­¢ä¿¡å·
        //    - peek & å›è°ƒ -> submit_to_context æ¢å¤æŒ‚èµ·åç¨‹
        m_engine.poll_submit();
    }
}
```

**ä¸ºä»€ä¹ˆ `notify_stop()` è¦å†™ eventfdï¼Ÿ**
 å› ä¸º `poll_submit()` å†…éƒ¨ä¼š `wait_eventfd()` é˜»å¡ï¼Œè‹¥åªè®¾ç½® `stop_token` è€Œä¸å†™ eventfdï¼Œçº¿ç¨‹å¯èƒ½â€œç¡æ­»â€ã€‚å†™ eventfd å¯å³æ—¶å”¤é†’å¾ªç¯æ£€æŸ¥åœæ­¢æ¡ä»¶ã€‚

## scheduler

### è§’è‰²ä¸æˆå‘˜

- **èŒè´£**ï¼šç®¡ç† N ä¸ª `context` çš„ç”Ÿå‘½å‘¨æœŸï¼›æä¾› `submit()` å°†ä»»åŠ¡**åˆ†å‘**åˆ°ä¸åŒ `context`ï¼›åœ¨**æ‰€æœ‰ context è¾¾åˆ°ç»ˆæ€**æ—¶å¹¿æ’­åœæ­¢ä¿¡å·ã€‚

- **å…³é”®æˆå‘˜**ï¼ˆä¸ä»£ç ä¸€è‡´ï¼‰

  ```
  size_t                        m_ctx_cnt{0};
  detail::ctx_container         m_ctxs;          // æŒæœ‰ N ä¸ª context
  detail::dispatcher<...>       m_dispatcher;    // è´Ÿè½½åˆ†å‘ï¼ˆé»˜è®¤ RRï¼‰
  
  // åœæ­¢åè®®ï¼ˆä½ å®ç°çš„â€œæ¥åŠ›æ£’â€ç»Ÿè®¡ï¼‰
  // - m_ctx_stop_flag[i].val: è¯¥ context æ˜¯å¦â€œæ´»è·ƒâ€ï¼ˆ1ï¼‰/â€œå·²ç»ˆæ€â€ï¼ˆ0ï¼‰
  // - m_stop_token: å…¨å±€â€œæ´»è·ƒä¸Šä¸‹æ–‡â€è®¡æ•°
  struct alignas(config::kCacheLineSize) atomic_ref_wrapper<int> { alignas(std::atomic_ref<int>::required_alignment) int val; };
  using stop_flag_type = std::vector<atomic_ref_wrapper<int>>;
  
  std::atomic<int> m_stop_token;  // å…¨å±€æ´»è·ƒæ•°
  stop_flag_type   m_ctx_stop_flag;
  ```

### åˆå§‹åŒ–ä¸åˆ†å‘

```
auto scheduler::init_impl(size_t ctx_cnt) noexcept -> void {
    detail::init_meta_info();
    m_ctx_cnt = ctx_cnt ? ctx_cnt : std::thread::hardware_concurrency();

    m_ctxs = detail::ctx_container{};
    m_ctxs.reserve(m_ctx_cnt);
    for (size_t i = 0; i < m_ctx_cnt; ++i) {
        m_ctxs.emplace_back(std::make_unique<context>());
    }
    m_dispatcher.init(m_ctx_cnt, &m_ctxs);

    // æ ‡è®°æ‰€æœ‰ context åˆå§‹â€œæ´»è·ƒâ€ï¼Œå¹¶è®¾ç½®å…¨å±€æ´»è·ƒæ•°
    m_ctx_stop_flag = stop_flag_type(m_ctx_cnt, atomic_ref_wrapper<int>{ .val = 1 });
    m_stop_token    = static_cast<int>(m_ctx_cnt);

#ifdef ENABLE_MEMORY_ALLOC
    // çœç•¥ï¼šå†…å­˜åˆ†é…å™¨åˆå§‹åŒ–
#endif
}

// ä»»åŠ¡æäº¤ï¼šåˆ†å‘åˆ°æŸä¸ª contextï¼Œå¹¶**æŒ‰éœ€å¢åŠ **å…¨å±€æ´»è·ƒæ•°
auto scheduler::submit_task_impl(std::coroutine_handle<> h) noexcept -> void {
    // é˜²å¾¡ï¼šloop ç»“æŸåä¸å†æ¥å—ä»»åŠ¡
    assert(m_stop_token.load(std::memory_order_acquire) != 0 && "submit after loop finish");

    size_t ctx_id = m_dispatcher.dispatch();

    // åªæœ‰å½“è¯¥ context å…ˆå‰å¤„äºâ€œç»ˆæ€(0)â€æ—¶ï¼Œé‡æ–°ç½® 1 å¹¶æŠŠå…¨å±€æ´»è·ƒæ•° +1
    auto& flag = m_ctx_stop_flag[ctx_id].val;
    int   was  = std::atomic_ref(flag).fetch_or(1, std::memory_order_acq_rel);
    if (was == 0) { m_stop_token.fetch_add(1, std::memory_order_acq_rel); }

    m_ctxs[ctx_id]->submit_task(h);
}
```

### loopï¼šå¯åŠ¨ã€æ¥åŠ›ç»Ÿè®¡ã€ç»Ÿä¸€åœæ­¢

```
auto scheduler::loop_impl() noexcept -> void {
    // 1) ä¸ºæ¯ä¸ª context æ³¨å…¥â€œåˆ°è¾¾ç»ˆæ€æ—¶â€çš„å›è°ƒï¼Œå¹¶å¯åŠ¨
    for (size_t i = 0; i < m_ctx_cnt; ++i) {
        m_ctxs[i]->set_stop_cb([&, i]() {
            // è¯¥ context ç¬¬ä¸€æ¬¡å®£å¸ƒâ€œç»ˆæ€â€ï¼šæŠŠè‡ªèº« flag ç”± 1 -> 0
            int dec = std::atomic_ref(m_ctx_stop_flag[i].val).fetch_and(0, std::memory_order_acq_rel);
            if (dec == 1) {
                // å…¨å±€æ´»è·ƒæ•° -1ï¼›è‹¥å½’é›¶ï¼Œå¹¿æ’­åœæ­¢ç»™æ‰€æœ‰ context
                if (m_stop_token.fetch_sub(1, std::memory_order_acq_rel) == 1) {
                    this->stop_impl();  // -> å¯¹æ‰€æœ‰ context: request_stop + eventfd å”¤é†’
                }
            }
        });
        m_ctxs[i]->start();
    }

    // ï¼ˆå®è·µå»ºè®®ï¼‰åœ¨æ­¤å¤„**join æ‰€æœ‰ context**ï¼Œä¿è¯ loop() ç›´åˆ°å…¨éƒ¨çº¿ç¨‹é€€å‡ºåæ‰è¿”å›
    // for (auto& c : m_ctxs) c->join();
}

auto scheduler::stop_impl() noexcept -> void {
    for (size_t i = 0; i < m_ctx_cnt; ++i) {
        m_ctxs[i]->notify_stop();   // request_stop + wake_up(1)
    }
}
```

**å·¥ä½œæ–¹å¼ï¼ˆâ€œæ¥åŠ›æ£’â€æ¨¡å‹ï¼‰**

- æ¯ä¸ª `context` åœ¨å…¶ `run()` ä¸­æ£€æµ‹åˆ°â€œ**æ— ä»»åŠ¡ & æ—  I/O & æ— ç­‰å¾…**â€æ—¶ï¼Œä¼šè§¦å‘ `m_stop_cb()`ã€‚
- åœ¨ `scheduler::loop_impl()` ä¸­æˆ‘ä»¬æŠŠ `m_stop_cb` è®¾ä¸ºï¼š
  1. æŠŠè¯¥ context çš„æ´»è·ƒæ ‡å¿—ä» 1 æ¸… 0ï¼ˆä»…ç¬¬ä¸€æ¬¡æœ‰æ•ˆï¼‰ï¼›
  2. å…¨å±€æ´»è·ƒæ•° `m_stop_token` è‡ªå‡ï¼›
  3. è‹¥è‡ªå‡åˆ° 0ï¼ˆæ‰€æœ‰ context éƒ½å®£å¸ƒâ€œç»ˆæ€â€ï¼‰ï¼Œè°ƒç”¨ `stop_impl()` **ç»Ÿä¸€å‘åœæ­¢ä¿¡å·**ã€‚
- ä¸€æ—¦å‘å‡ºåœæ­¢ä¿¡å·ï¼Œå„ context é€šè¿‡ `eventfd` è¢«å”¤é†’ï¼Œ`stop_token` ä¹Ÿä¸ºçœŸï¼Œæœ€ç»ˆæ»¡è¶³é€€å‡ºæ¡ä»¶å¹¶æ”¶å°¾é€€å‡ºã€‚

**å»ºè®®**ï¼šåœ¨ `loop_impl()` æœ«å°¾å¯¹æ‰€æœ‰ `context` æ‰§è¡Œ `join()`ï¼Œç¡®ä¿ `scheduler::loop()` **é˜»å¡åˆ°æ‰€æœ‰çº¿ç¨‹é€€å‡º**å†è¿”å›ï¼›è¿™æ ·å¯ä»¥æ»¡è¶³â€œç”¨æˆ·åªéœ€è°ƒç”¨ `loop()` ç­‰å¾…å…¨éƒ¨ç»“æŸâ€çš„ API è¯­ä¹‰ã€‚

### Contextâ€“Schedulerâ€“Engine çš„åä½œè¦ç‚¹

1. **æäº¤è·¯å¾„**
   - `scheduler::submit(task&&)` â†’ å³å€¼ `detach()` â†’ é€‰ä¸­ `ctx_i` â†’ `ctx_i->submit_task(handle)` â†’ `engine.submit_task(handle)`ï¼ˆå…¥é˜Ÿ + å†™ eventfd å”¤é†’ï¼‰ã€‚
2. **æ‰§è¡Œè·¯å¾„**
   - `context::run()`ï¼šå…ˆæ‰¹é‡è·‘å®Œå½“å‰ä»»åŠ¡ï¼Œç„¶å `poll_submit()`ï¼ˆç­‰å¾… I/O æˆ–æ–°ä»»åŠ¡æˆ–åœæ­¢ï¼‰ï¼›
   - I/O å®Œæˆï¼š`engine.poll_submit()` å–å› CQE â†’ å›è°ƒ `submit_to_context(handle)` â†’ å¥æŸ„å†æ¬¡å…¥é˜Ÿæ¢å¤ï¼›
   - åç¨‹ `done()` åç”± `engine.clean()` æ¸…ç† **detached** åç¨‹å¸§ã€‚
3. **åœæ­¢è·¯å¾„**
   - **å• context**ï¼šé»˜è®¤ `m_stop_cb = request_stop`ï¼Œåœ¨ `empty_wait_task()` ä¸”æ— é˜Ÿåˆ—ä»»åŠ¡æ—¶è‡ªåœï¼›
   - **å¤š contextï¼ˆscheduler ç®¡æ§ï¼‰**ï¼šå„ context åˆ°è¾¾â€œç»ˆæ€â€å›è°ƒç»Ÿè®¡ï¼›æœ€åä¸€ä¸ªè§¦å‘ `stop_impl()` â†’ å¹¿æ’­ `notify_stop()`ï¼›**å»ºè®®éšå join**ã€‚
4. **æŒ‚èµ·å¼•ç”¨è®¡æ•°ï¼ˆwait_cntï¼‰**
   - åç¨‹åœ¨è¿›å…¥æŸäº›åŒæ­¥åŸè¯­ï¼ˆe.g., future ç»“æœæœªå°±ç»ªï¼‰æ—¶è°ƒç”¨ `register_wait()`ï¼Œåœ¨æ¢å¤å `unregister_wait()`ï¼›
   - åœæ­¢æ¡ä»¶å¿…é¡» **é¢å¤–**æ£€æŸ¥ `m_wait_cnt == 0`ï¼Œå¦åˆ™ä¼šåœ¨ä»æœ‰â€œæŒ‚èµ·åç¨‹â€æ—¶æå‰é€€å‡ºï¼Œå¯¼è‡´æ³„æ¼ã€‚

------

## å…³é”®ä¸å˜é‡ä¸è‡ªæ£€æ¸…å•

- `context::notify_stop()` å¿…é¡»åŒæ—¶ `request_stop()` **å¹¶** `engine.wake_up(1)`ï¼Œé¿å…ç¡æ­»ã€‚
- `empty_wait_task()` åˆ¤æ–­ = `engine.empty_io()` **ä¸”** `m_wait_cnt == 0`ï¼›é€€å‡ºå‰è¿˜è¦ç¡®ä¿é˜Ÿåˆ— `!ready()`ã€‚
- `scheduler::submit_task_impl()` åœ¨ loop ç»“æŸååº”æ‹’ç»/æ–­è¨€æäº¤ï¼ˆä½ å·²æœ‰æ–­è¨€ï¼‰ã€‚
- `scheduler::loop_impl()` æœ€å¥½**join** æ‰€æœ‰ contextï¼Œç¡®ä¿ `loop()` å‡½æ•°é˜»å¡è‡³ç»“æŸã€‚
- `dispatcher` çš„åˆ†å‘ç­–ç•¥ï¼ˆRRï¼‰å¯æ›´æ¢ï¼›ä½ åœ¨æäº¤æ—¶å·²æŒ‰éœ€æ¢å¤â€œæ´»è·ƒè®¡æ•°â€ã€‚

### æ€»ç»“ï¼ˆcontext+scheduler)

â€œæ¯ä¸ª `context` æ‹¥æœ‰ç§æœ‰ `engine` å’Œä¸€ä¸ª `jthread`ã€‚`run()` æ¯è½®å…ˆæŠŠå½“å‰ä»»åŠ¡æ‰¹é‡ `resume`ï¼Œç„¶åè¿›å…¥ `poll_submit()` ä½œä¸ºç»Ÿä¸€ç¡çœ ç‚¹ï¼šI/O å®Œæˆã€æ–°ä»»åŠ¡æäº¤æˆ–åœæ­¢ä¿¡å·éƒ½ä¼šç”¨ eventfd å”¤é†’ã€‚`register_wait/unregister_wait` æ˜¯æŒ‚èµ·å¼•ç”¨è®¡æ•°ï¼Œç”¨æ¥é˜»æ­¢åœ¨è¿˜æœ‰æŒ‚èµ·åç¨‹æ—¶æå‰é€€å‡ºã€‚`scheduler` ç®¡æ§å¤šä¸ª `context`ï¼›ç”¨æ¯ä¸ª context çš„ `stop_cb` åšâ€˜æ¥åŠ›æ£’ç»Ÿè®¡â€™ï¼Œæ‰€æœ‰ context å®£å¸ƒâ€˜ç»ˆæ€â€™æ—¶ç»Ÿä¸€ `notify_stop()` å¹¿æ’­åœæ­¢ã€‚ä»»åŠ¡æäº¤èµ° dispatcher åˆ†å‘ï¼Œå³å€¼ `task` ä¼š `detach`ï¼Œç”±å¼•æ“åœ¨ `done()` åæ¸…ç†åç¨‹å¸§ï¼Œå®ç°å®Œæ•´çš„è°ƒåº¦ä¸èµ„æºæ‰˜ç®¡é—­ç¯ã€‚â€

## å¼‚æ­¥IOæ‰§è¡Œæ¨¡å—å°è£…

1. **åŸºäº `base_io_awaiter` ç”Ÿæˆ `io_awaiter`**

ä½ ä» `base_io_awaiter` ç»§æ‰¿å¹¶æ„é€ è‡ªå·±çš„ `awaiter` ç±»ï¼ˆä¾‹å¦‚ `tcp_accept_awaiter`ï¼‰ï¼Œè¿™ä¸€æ­¥çš„ç›®çš„æ˜¯è®©ä½ ä¸ºæ¯ç§ I/O æ“ä½œå®šä¹‰ä¸€ä¸ªç‰¹å®šçš„ **awaiter ç±»å‹**ã€‚

- `base_io_awaiter` ä½œä¸ºæ‰€æœ‰ I/O æ“ä½œçš„åŸºç±»ï¼Œè´Ÿè´£å¤„ç†æŒ‚èµ·ï¼ˆ`await_suspend`ï¼‰å’Œæ¢å¤ï¼ˆ`await_resume`ï¼‰åç¨‹çš„é€»è¾‘ã€‚
- `io_info` ç»“æ„ä½“åŒ…å«äº†åç¨‹å¥æŸ„ã€å›è°ƒå‡½æ•°ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå®ƒä¼šåœ¨ `awaiter` å†…éƒ¨ä¼ é€’å’Œä½¿ç”¨ã€‚

2. **è°ƒç”¨ `co_await custom_io_awaiter` çš„æµç¨‹**

å½“ä½ åœ¨åç¨‹ä¸­è°ƒç”¨ `co_await` æ¥ç­‰å¾… I/O æ“ä½œæ—¶ï¼Œä»¥ä¸‹è¿‡ç¨‹ä¼šå‘ç”Ÿï¼š

1. **æ„é€  `awaiter`**ï¼š
   - `co_await` ä¼šæ„é€ ä¸€ä¸ª `io_awaiter` ç±»çš„å®ä¾‹ï¼ˆæ¯”å¦‚ `tcp_accept_awaiter`ï¼‰ã€‚
   - åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œä½ ä¼šå‡†å¤‡ I/O æ“ä½œçš„å‚æ•°ï¼Œå¹¶å°†å…¶å¡«å……åˆ° `sqe` ä¸­ï¼ŒåŒæ—¶å°† `io_info` ç»‘å®šåˆ° `sqe`ã€‚
2. **æäº¤ I/O æ“ä½œ**ï¼š
   - åœ¨ `awaiter` çš„æ„é€ å‡½æ•°é‡Œï¼Œè°ƒç”¨ `local_engine().add_io_submit()`ï¼Œå°† I/O æ“ä½œæäº¤åˆ° `engine`ï¼Œè¿™æ—¶ I/O è¯·æ±‚è¢«æ”¾å…¥å†…æ ¸çš„æäº¤é˜Ÿåˆ—ï¼ˆSQEï¼‰ã€‚
3. **æŒ‚èµ·åç¨‹**ï¼š
   - `await_suspend()` æ–¹æ³•ä¼šåœ¨è¿™é‡Œæ‰§è¡Œï¼Œåç¨‹ä¼šè¿›å…¥ **æŒ‚èµ·çŠ¶æ€**ã€‚è¿™æ—¶ï¼Œ`io_info` çš„ `handle` ä¼šä¿å­˜å½“å‰åç¨‹çš„å¥æŸ„ï¼Œå¹¶ä¸”åç¨‹å°†ç­‰å¾… I/O å®Œæˆã€‚
   - `await_suspend` ä¸ä¼šç«‹å³æ¢å¤åç¨‹ï¼Œè€Œæ˜¯å°†å…¶æŒ‚èµ·ï¼Œç­‰å¾…å¤–éƒ¨çš„ I/O å®Œæˆå›è°ƒæ¥æ¢å¤ã€‚

3. **å”¤é†’å·¥ä½œçº¿ç¨‹å¹¶æäº¤ I/O æ“ä½œ**

1. **`poll_submit` è¢«è°ƒç”¨**ï¼š
   - `poll_submit()` ä¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ I/O æ“ä½œå·²ç»å®Œæˆã€‚å¦‚æœæ²¡æœ‰å®Œæˆçš„ä»»åŠ¡ï¼Œå®ƒä¼šé€šè¿‡ `m_upxy.write_eventfd()` å”¤é†’é˜»å¡çš„å·¥ä½œçº¿ç¨‹ã€‚
   - è¿™ä¸ªå”¤é†’æ“ä½œä½¿å¾— `context::run` ä¸­çš„å·¥ä½œçº¿ç¨‹èƒ½å¤Ÿç»§ç»­æ‰§è¡Œï¼Œå¹¶å¼€å§‹å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„åç¨‹ã€‚
2. **å·¥ä½œçº¿ç¨‹æ‰§è¡Œ `exec_one_task`**ï¼š
   - `exec_one_task()` ä¼šä»ä»»åŠ¡é˜Ÿåˆ— `m_task_queue` ä¸­å–å‡ºä¸€ä¸ªåç¨‹å¥æŸ„ï¼Œå¹¶æ¢å¤è¯¥åç¨‹çš„æ‰§è¡Œï¼ˆè°ƒç”¨ `handle.resume()`ï¼‰ã€‚
   - `exec_one_task()` çš„å…³é”®ç‚¹æ˜¯ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‹¿å‡ºä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ¢å¤å…¶æ‰§è¡Œã€‚

4. **I/O å®Œæˆåçš„ `callback` æ‰§è¡Œ**

- å½“ I/O æ“ä½œå®Œæˆæ—¶ï¼ˆä¾‹å¦‚ TCP è¿æ¥æˆåŠŸï¼‰ï¼Œ**å›è°ƒå‡½æ•°**ä¼šè¢«è°ƒç”¨ã€‚
- å›è°ƒå‡½æ•°åœ¨ `callback` ä¸­æ‰§è¡Œæ—¶ï¼Œä¼šæŠŠ I/O æ“ä½œçš„ç»“æœï¼ˆå¦‚æ¥æ”¶çš„æ•°æ®ã€é”™è¯¯ç ç­‰ï¼‰æ”¾å› `io_info.result`ã€‚
- ç„¶åï¼Œå›è°ƒå‡½æ•°è°ƒç”¨ `submit_to_context(data->handle)`ï¼Œå°† **åç¨‹å¥æŸ„** æäº¤åˆ°å½“å‰ `context` ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‡†å¤‡æ¢å¤åç¨‹ã€‚

5. **æ¢å¤åç¨‹ï¼š**

1. **`submit_to_context(data->handle)`**ï¼š
   - è¿™å°†åç¨‹å¥æŸ„ï¼ˆ`data->handle`ï¼‰æ”¾å…¥ `context` çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç¡®ä¿å·¥ä½œçº¿ç¨‹èƒ½å¤Ÿä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚
   - å·¥ä½œçº¿ç¨‹åœ¨ `exec_one_task()` ä¸­é€šè¿‡ `m_task_queue.pop()` è·å–ä»»åŠ¡å¹¶æ¢å¤æ‰§è¡Œã€‚
2. **åç¨‹æ¢å¤æ‰§è¡Œ**ï¼š
   - å½“å·¥ä½œçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºåç¨‹å¥æŸ„æ—¶ï¼Œè°ƒç”¨ `handle.resume()` æ¢å¤åç¨‹æ‰§è¡Œã€‚åç¨‹å°†ç»§ç»­ä»æŒ‚èµ·çš„ä½ç½®å¼€å§‹æ‰§è¡Œã€‚

6. **æ€»ç»“**

- **`awaiter` é€šè¿‡ `base_io_awaiter` ç»§æ‰¿å®ç°å…·ä½“çš„ I/O æ“ä½œ**ï¼Œå¹¶åœ¨ `await_suspend()` ä¸­æŒ‚èµ·åç¨‹ï¼Œç­‰å¾… I/O å®Œæˆã€‚
- **æäº¤ I/O æ“ä½œæ—¶**ï¼ŒI/O ä¼šè¢«æäº¤åˆ° `engine`ï¼ŒåŒæ—¶é€šè¿‡ `add_io_submit()` å”¤é†’å·¥ä½œçº¿ç¨‹ï¼Œç­‰å¾…æ‰§è¡Œã€‚
- **å½“ I/O å®Œæˆæ—¶**ï¼Œå›è°ƒå‡½æ•°è¢«æ‰§è¡Œï¼Œå¹¶é€šè¿‡ `submit_to_context(data->handle)` æ¢å¤æŒ‚èµ·çš„åç¨‹ã€‚
- **å·¥ä½œçº¿ç¨‹** åœ¨ `poll_submit()` è¢«å”¤é†’åï¼Œè°ƒç”¨ `exec_one_task()` ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºåç¨‹ï¼Œæ¢å¤æ‰§è¡Œã€‚

7. **ä¸ºä»€ä¹ˆ `submit_task` æ¢å¤åç¨‹**

- `submit_task` å°†åç¨‹å¥æŸ„æ”¾å›ä»»åŠ¡é˜Ÿåˆ—ï¼ˆ`m_task_queue`ï¼‰ã€‚
- `exec_one_task` é€šè¿‡ `m_task_queue.pop()` å–å‡ºåç¨‹å¥æŸ„å¹¶æ¢å¤æ‰§è¡Œã€‚
- æ¢å¤æ‰§è¡Œçš„åç¨‹ä» I/O æ“ä½œå®Œæˆåçš„æŒ‚èµ·ç‚¹ç»§ç»­è¿è¡Œï¼Œå®ŒæˆåŸæœ¬çš„ä»»åŠ¡ã€‚

è¿™ç§è®¾è®¡çš„å…³é”®åœ¨äºé€šè¿‡**ä»»åŠ¡é˜Ÿåˆ—å’Œ `submit_task`**ï¼Œå°†æ¯ä¸ª I/O æ“ä½œçš„åç¨‹å¥æŸ„ä¿å­˜èµ·æ¥ï¼Œç¡®ä¿åœ¨ I/O å®Œæˆåå¯ä»¥é€šè¿‡å·¥ä½œçº¿ç¨‹æ¢å¤åç¨‹çš„æ‰§è¡Œã€‚



## é¢è¯•è¯´æ³•

### ä¸ºä»€ä¹ˆ è¯´åç¨‹å•ç‹¬ä½¿ç”¨æ˜¯æ²¡æœ‰ä»€ä¹ˆç”¨çš„

**åç¨‹åªæ˜¯è¯­æ³•ç³–ï¼Œæœ¬èº«å¹¶ä¸äº§ç”Ÿâ€œå¹¶å‘â€æˆ–â€œæ€§èƒ½æå‡â€**ã€‚

> ## 1. åç¨‹å•ç‹¬ä½¿ç”¨æ—¶çš„æœ¬è´¨
>
> - C++20 åç¨‹æ˜¯ä¸€ç§**ç¼–è¯‘å™¨æ”¹å†™æœºåˆ¶**ï¼šç¼–è¯‘å™¨ä¼šæŠŠ `co_await / co_yield / co_return` æ”¹å†™æˆä¸€ä¸ª**çŠ¶æ€æœº + åç¨‹å¸§å¯¹è±¡**ã€‚
> - å¦‚æœä½ åªæœ‰åç¨‹ï¼Œæ²¡æœ‰é…å¥—çš„è°ƒåº¦å™¨/IOæ¥å£ï¼Œé‚£åç¨‹å°±æ˜¯**åœ¨å•çº¿ç¨‹é‡Œåˆ‡æ¥åˆ‡å»**ï¼Œå®ƒå¹¶ä¸èƒ½ï¼š
>   - æŠŠè®¡ç®—è‡ªåŠ¨åˆ†ç»™å¤šä¸ª CPUï¼›
>   - æŠŠ IO è‡ªåŠ¨å˜å¿«ã€‚
> - ç›¸åï¼Œå®ƒç”šè‡³æ¯”ä¸€ä¸ªæ™®é€šå‡½æ•°æ›´é‡ï¼šè¦ç»´æŠ¤åç¨‹å¸§ã€promise_typeã€handleï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼Œå¸¦æ¥é¢å¤–å¼€é”€ã€‚
>
> æ‰€ä»¥å®éªŒè€…å¦‚æœåªæ˜¯å†™ï¼š
>
> ```
> Task foo() {
>     std::cout << "A\n";
>     co_await std::suspend_always{};
>     std::cout << "B\n";
> }
> ```
>
> å’Œä½ å†™ä¸€ä¸ª `switch` çŠ¶æ€æœºï¼Œæˆ–è€…å†™ä¸¤ä¸ªå‡½æ•°æ‰‹åŠ¨è°ƒç”¨ï¼Œ**æ²¡æœ‰æœ¬è´¨æ€§èƒ½åŒºåˆ«**ã€‚å•çº¯â€œåˆ‡ç‰‡â€ä¸ä¼šè®©ç¨‹åºæ›´å¿«ã€‚
>
> ------
>
> ## 2. ä¸ºä»€ä¹ˆè¯´â€œåç¨‹å•ç‹¬ä½¿ç”¨æ²¡ç”¨â€
>
> - å®ƒä¸ä¼šè®©ä½ çš„ç¨‹åº**è‡ªåŠ¨å¹¶è¡Œ**ï¼ˆä¸æ˜¯åƒçº¿ç¨‹æ± é‚£æ ·å¹¶å‘æ‰§è¡Œï¼‰ã€‚
> - å®ƒä¸ä¼šè®© IO **è‡ªåŠ¨å˜å¿«**ï¼ˆåº•å±‚å¦‚æœæ˜¯é˜»å¡ IOï¼Œåç¨‹åˆ‡ä¸èµ°ï¼‰ã€‚
> - å®ƒåè€Œä¼šå› ä¸ºï¼š
>   - åˆ›å»º/é”€æ¯åç¨‹å¸§ï¼›
>   - handle çš„ç®¡ç†ï¼›
>   - çŠ¶æ€æœºçš„é¢å¤–è·³è½¬ï¼›
>      å¸¦æ¥**å¼€é”€**ï¼Œåœ¨åªåšè®¡ç®—ä»»åŠ¡æ—¶ç”šè‡³æ¯”æ™®é€šå‡½æ•°è¿˜æ…¢ã€‚
>
> æ¢å¥è¯è¯´ï¼Œå¦‚æœä½ åªæ˜¯æŠŠ for å¾ªç¯æ”¹æˆ `co_yield`ï¼Œä½ å¾—åˆ°çš„åªæ˜¯å†™æ³•ä¸åŒï¼Œæ€§èƒ½æœªå¿…æ›´å¥½ã€‚
>
> ------
>
> ## 3. åç¨‹çœŸæ­£å‘æŒ¥ä½œç”¨è¦é…åˆä»€ä¹ˆ
>
> åç¨‹çš„ä»·å€¼åœ¨äº**æŠŠâ€œç­‰å¾…â€å˜æˆâ€œæŒ‚èµ·â€ï¼Œä»è€ŒèŠ‚çœèµ„æº**ã€‚è¿™è¦å’Œ **IO æˆ–è°ƒåº¦æ¡†æ¶**ç»“åˆä½¿ç”¨ï¼š
>
> - **å¼‚æ­¥ IO**ï¼ˆepoll/kqueue/IOCPã€Linux io_uringï¼‰ï¼š
>    å½“ä½  `co_await socket.read()`ï¼Œåç¨‹æŒ‚èµ· â†’ CPU å»å¹²åˆ«çš„äº‹ â†’ æ•°æ®åˆ°æ¥æ—¶å†æ¢å¤ã€‚
>    â†’ é¿å…äº†çº¿ç¨‹é˜»å¡ã€å‡å°‘çº¿ç¨‹åˆ‡æ¢æˆæœ¬ã€‚
> - **è°ƒåº¦å™¨/äº‹ä»¶å¾ªç¯**ï¼ˆlibuv, ASIO, follyï¼‰ï¼š
>    åç¨‹è®©ä½ å†™â€œçœ‹èµ·æ¥åŒæ­¥â€çš„ä»£ç ï¼Œä½†åº•å±‚å´æ˜¯äº‹ä»¶é©±åŠ¨ã€‚
>    â†’ å¯ç»´æŠ¤æ€§ + æ€§èƒ½ã€‚
> - **é…åˆå¤šçº¿ç¨‹/çº¿ç¨‹æ± **ï¼š
>    åç¨‹å¯ä»¥å½“ä½œç”¨æˆ·æ€è½»é‡ä»»åŠ¡ï¼Œç”¨è°ƒåº¦å™¨åˆ†å‘åˆ°çº¿ç¨‹æ± ã€‚
>    â†’ æ¯”æ“ä½œç³»ç»Ÿçº¿ç¨‹åˆ‡æ¢æ›´è½»ï¼Œæå‡å¹¶å‘åº¦ã€‚
>
> ------
>
> ## 4. å°ç»“
>
> æ‰€ä»¥é‚£å¥è¯çš„æ„æ€æ˜¯ï¼š
>
> > **åç¨‹å•ç‹¬ä½¿ç”¨æ—¶ï¼Œä½ åªæ˜¯åœ¨ç”¨è¯­æ³•ç³–ç”ŸæˆçŠ¶æ€æœºï¼Œæ—¢æ²¡æœ‰å¹¶å‘ï¼Œä¹Ÿæ²¡æœ‰æ›´å¿«çš„ IOï¼Œåè€Œæœ‰å¼€é”€ã€‚**
> >  **åç¨‹å¿…é¡»å’Œè°ƒåº¦å™¨/IOç³»ç»Ÿç»“åˆï¼Œæ‰èƒ½æŠŠâ€œæŒ‚èµ·ç­‰å¾…â€è½¬åŒ–ä¸ºâ€œé«˜æ•ˆå¼‚æ­¥â€ï¼Œè¿™æ‰æ˜¯å®ƒçš„ä»·å€¼ã€‚**



```mermaid
flowchart TD

A1[æ™®é€šå‡½æ•°] --> A2[è°ƒç”¨å‡½æ•°]
A2 --> A3[æ‰§è¡Œåˆ°é˜»å¡IO/è€—æ—¶ä»»åŠ¡]
A3 --> A4[çº¿ç¨‹é˜»å¡ç­‰å¾…]
A4 --> A5[ä»»åŠ¡å®Œæˆ, è¿”å›ç»“æœ]

B1[å•çº¯åç¨‹] --> B2[è°ƒç”¨åç¨‹]
B2 --> B3[æ‰§è¡Œåˆ° co_await std::suspend_always]
B3 --> B4[ç¼–è¯‘å™¨ç”ŸæˆçŠ¶æ€æœº + åç¨‹å¸§]
B4 --> B5[ä¾ç„¶å•çº¿ç¨‹æ‰§è¡Œ, æ²¡æœ‰å¹¶å‘]
B5 --> B6[æ€§èƒ½ç”šè‡³æ›´å·®, å› ä¸ºå¤šäº†çŠ¶æ€æœºå¼€é”€]

C1[åç¨‹ + IO/è°ƒåº¦å™¨] --> C2[è°ƒç”¨åç¨‹]
C2 --> C3[æ‰§è¡Œåˆ° co_awaitstd::suspend_always]
C3 --> C4[åç¨‹æŒ‚èµ·, ä¿å­˜çŠ¶æ€]
C4 --> C5[äº‹ä»¶å¾ªç¯/è°ƒåº¦å™¨å»ç­‰å¾…IO]
C5 --> C6[CPUå»è¿è¡Œå…¶ä»–ä»»åŠ¡]
C6 --> C7[IOå®Œæˆ, è°ƒåº¦å™¨æ¢å¤åç¨‹]
C7 --> C8[åç¨‹ä»æŒ‚èµ·ç‚¹ç»§ç»­æ‰§è¡Œ]

```

### çº¿ç¨‹æ± å¯¹æ¯”åç¨‹

| ç»´åº¦       | çº¿ç¨‹æ±  + é˜»å¡I/O                   | åç¨‹ + å¼‚æ­¥I/Oï¼ˆepoll/kqueue/IOCP/io_uringï¼‰              |
| ---------- | ---------------------------------- | --------------------------------------------------------- |
| å¹¶å‘æ¨¡å‹   | OS çº¿ç¨‹å¹¶å‘ï¼›æ¯ä¸ªé˜»å¡å ç”¨ä¸€ä¸ªçº¿ç¨‹  | å•/å°‘é‡çº¿ç¨‹ä¸Šè·‘**å¤§é‡ç”¨æˆ·æ€ä»»åŠ¡**ï¼›ç­‰å¾…æ—¶**æŒ‚èµ·ä¸å çº¿ç¨‹** |
| ä¸Šä¸‹æ–‡åˆ‡æ¢ | çº¿ç¨‹åˆ‡æ¢ï¼ˆå†…æ ¸æ€ï¼‰ï¼Œæˆæœ¬é«˜         | åç¨‹åˆ‡æ¢ï¼ˆç”¨æˆ·æ€ï¼‰ï¼Œæˆæœ¬ä½                                |
| I/O ç­‰å¾…   | çº¿ç¨‹è¢«é˜»å¡ï¼Œæ ¸å¿ƒç©ºè½¬               | äº‹ä»¶é©±åŠ¨ï¼Œç­‰å¾…æ—¶è®©å‡º CPU                                  |
| å†…å­˜å ç”¨   | æ¯çº¿ç¨‹æ ˆå†…å­˜è¾ƒå¤§ï¼ˆMB çº§ï¼‰          | åç¨‹å¸§æŒ‰éœ€åˆ†é…ï¼ˆKB çº§ï¼‰ï¼Œæ•°é‡æ˜“æ‰©å±•                       |
| å¯ç»´æŠ¤æ€§   | å›è°ƒå°‘ï¼Œä»£ç ç›´è§‚ï¼Œä½†éœ€å°å¿ƒçº¿ç¨‹å®‰å…¨ | `co_await` å†™â€œåŒæ­¥é£æ ¼â€çš„å¼‚æ­¥ï¼Œé€»è¾‘æ›´çº¿æ€§                 |
| æé™å¹¶å‘   | å—çº¿ç¨‹æ•°ã€æ ˆå†…å­˜ã€è°ƒåº¦å¼€é”€é™åˆ¶     | å—äº‹ä»¶å¾ªç¯ä¸ä»»åŠ¡é˜Ÿåˆ—èƒ½åŠ›é™åˆ¶ï¼Œæ˜“è¾¾æ›´é«˜å¹¶å‘                |
| è®¡ç®—å¯†é›†   | çº¿ç¨‹æ± åˆé€‚ï¼ˆCPU ç»‘å®šä»»åŠ¡ï¼‰         | éœ€è¦é…åˆè°ƒåº¦å™¨æŠŠè®¡ç®—ä»»åŠ¡åˆ†å‘åˆ°å·¥ä½œçº¿ç¨‹                    |
| æ’é”™éš¾åº¦   | æ­»é”/ç«äº‰æ¡ä»¶ç»å…¸å‘                | ç”Ÿå‘½å‘¨æœŸ/æ‚¬ç©º handleã€åŒé‡é”€æ¯ã€æœª resume                 |

> # ä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªï¼Ÿ
>
> - **ç”¨çº¿ç¨‹æ± ï¼ˆé˜»å¡ I/Oï¼‰**
>   - è¿æ¥æ•°ä¸­å°è§„æ¨¡ï¼ˆ10^2 ~ 10^4ï¼‰ã€é€»è¾‘ç®€å•ã€å›¢é˜Ÿå·²æœ‰æˆç†Ÿçº¿ç¨‹æ± æ¡†æ¶ã€‚
>   - ä»¥**CPU è®¡ç®—**ä¸ºä¸»ï¼ˆå›¾åƒå¤„ç†ã€åŠ è§£å¯†ã€å‹ç¼©ï¼‰ï¼ŒI/O ç­‰å¾…çŸ­ã€‚
> - **ç”¨åç¨‹ + å¼‚æ­¥ I/O**
>   - é«˜å¹¶å‘è¿æ¥/é•¿è¿æ¥ï¼ˆIMã€ç½‘å…³ã€æ¨é€ã€RPC æœåŠ¡ç«¯ã€ä»£ç†ï¼‰ã€‚
>   - I/O ç­‰å¾…å æ¯”é«˜ï¼ˆç½‘ç»œ/ç£ç›˜/æ•°æ®åº“ï¼‰ï¼Œéœ€è¦**é‡Šæ”¾çº¿ç¨‹å»å¤„ç†å…¶ä»–ä»»åŠ¡**ã€‚
>   - è¿½æ±‚**ä½å†…å­˜å ç”¨**ä¸**ç”¨æˆ·æ€è½»é‡è°ƒåº¦**ã€é¿å…çº¿ç¨‹é£æš´ã€‚
> - **æ··åˆ**ï¼ˆå¼ºçƒˆæ¨èçš„å·¥ç¨‹æ–¹æ¡ˆï¼‰
>   - **I/O ç”¨åç¨‹ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰**ï¼Œ**CPU-heavy å­ä»»åŠ¡ä¸¢ç»™çº¿ç¨‹æ± **å¤„ç†ï¼š
>      `co_await async_read()` â†’ `co_await thread_pool.awaitable(post(work)))` â†’ `co_await async_write()`ã€‚

### tinyCoroå…·ä½“è®¾è®¡

tinyCoro çš„æ ¸å¿ƒéƒ¨åˆ†å¤šçº¿ç¨‹æ‰§è¡Œå¼•æ“ç”±`engine`ã€`context`å’Œ`scheduler`ä¸‰éƒ¨åˆ†ç»„æˆã€‚

æ¯ä¸ª`engine`æŒæœ‰ä¸€ä¸ª io_uring å®ä¾‹å’Œæ— é”å·¥ä½œé˜Ÿåˆ—ï¼Œå·¥ä½œé˜Ÿåˆ—ç”¨äºå­˜å‚¨åç¨‹ä»»åŠ¡ï¼Œio_uring å®ä¾‹ç”¨æ¥å¤„ç† IO ä»»åŠ¡ã€‚

æ¯ä¸ª`context`æŒæœ‰ä¸€ä¸ª`engine`å’Œä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå…¶ä¸­å·¥ä½œçº¿ç¨‹åˆ©ç”¨äº‹ä»¶å¾ªç¯çš„æ–¹å¼é©±åŠ¨ engine æ‰§è¡Œå®Œæ‰€æœ‰çš„ä»»åŠ¡ã€‚

`scheduler`åœ¨å…¨å±€åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ï¼Œè‡ªèº«æŒæœ‰å¤šä¸ª context å¹¶è´Ÿè´£å°†æ–°äº§ç”Ÿçš„ä»»åŠ¡æ ¹æ®è´Ÿè½½å‡è¡¡é€»è¾‘æ´¾å‘åˆ°æŒ‡å®š`context`ã€‚

ç»¼åˆæ¥çœ‹ä¸‰è€…ä¹‹é—´çš„å…³ç³»å°±åƒä¸€ä¸ªå†›é˜Ÿï¼Œ`engine`ä¸ºæ­¦å™¨ï¼Œ`context`ä¸ºå£«å…µï¼Œæ¯ä¸ªå£«å…µæŒæœ‰ä¸€æŠŠæ­¦å™¨ä¸”åªæœ‰æŒæœ‰äº†æ­¦å™¨çš„å£«å…µæ‰å¯ä»¥ä½œæˆ˜ï¼Œ`scheduler`ä½œä¸ºå¸ä»¤å®˜è´Ÿè´£ä¸ºå£«å…µæ´¾å‘ä»»åŠ¡ã€‚

å¯¹äº IO æ‰§è¡Œéƒ¨åˆ†ï¼Œæ¯å½“åç¨‹å‘èµ·ä¸€ä¸ªåç¨‹ä»»åŠ¡æ—¶ä¼šé‡‡ç”¨`co_await io_awaiter`çš„è°ƒç”¨ï¼Œ`io_awaiter`ä¼šä» io_uring è·å– sqe å¹¶æ ¹æ® IO ç±»å‹å¡«å…… sqe ç„¶åæäº¤ï¼Œæ³¨æ„ä¸º sqe å¡«å……çš„ä¿¡æ¯åŒ…å«ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œéšåè¯¥åç¨‹é™·å…¥ suspend çŠ¶æ€å¹¶è½¬ç§»æ‰§è¡Œæƒï¼Œè¿™æ ·å·¥ä½œçº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œç­‰åˆ° IO æ‰§è¡Œå®Œæˆåå·¥ä½œçº¿ç¨‹å–å‡º cqe å¹¶è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°ä¼šå‘ä»»åŠ¡é˜Ÿåˆ—æäº¤åç¨‹å¥æŸ„ä»è€Œæ¢å¤åç¨‹æ‰§è¡Œã€‚åœ¨ç”¨æˆ·çœ‹æ¥è¿™å°±æ˜¯ä¸ªåŒæ­¥è°ƒç”¨ï¼Œä½†å®é™…ä¸Šæ‰§è¡Œå¼•æ“ä¼šé‡‡ç”¨å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œã€‚



### tinyCoroäº®åº¦å’Œéš¾ç‚¹

ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š

- **çº¿ç¨‹ç‹¬ç«‹çš„æ‰§è¡Œå¼•æ“ï¼š** å¤šçº¿ç¨‹æ‰§è¡Œå¼•æ“ä¸­å„ä¸ª context æŒæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¸”å½¼æ­¤ç›¸äº’ç‹¬ç«‹ï¼Œé€šè¿‡`scheduler`æ¥ä¿è¯ä»»åŠ¡çš„å‡è¡¡åˆ†é…ï¼Œè¿™æ ·æ—¢èƒ½åˆ©ç”¨å¤šçº¿ç¨‹åˆå¯ä»¥æœ€å¤§é™åº¦é™ä½çº¿ç¨‹ç«äº‰å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚
- **åŸºäº eventfd çš„è½»é‡çº§äº‹ä»¶å¾ªç¯ï¼š** tinCoro æ‰§è¡Œå¼•æ“æœ¬èº«çš„äº‹ä»¶å¾ªç¯æ˜¯é‡‡ç”¨è½»é‡çš„ eventfd å®Œæˆçš„ï¼Œåœ¨æ²¡æœ‰ä»»ä½•ä»»åŠ¡æ—¶çº¿ç¨‹ä¼šé˜»å¡åœ¨ eventfd è¯»æ“ä½œä¸Šï¼Œå½“ io_uring äº§ç”Ÿ IO å®Œæˆäº‹ä»¶ä»¥åŠä»»åŠ¡é˜Ÿåˆ—æ”¶åˆ°æ–°ä»»åŠ¡æ—¶ä¼šè‡ªåŠ¨å‘ eventfd å†™å€¼ï¼Œè¿™ä¿è¯äº†çº¿ç¨‹è¢«åŠæ—¶å”¤é†’ç»§ç»­å¤„ç†ä»»åŠ¡ï¼Œeventfd çš„è¯»å†™æ˜¯ååˆ†è½»é‡çš„ï¼Œä¸€æ¬¡è¯»å†™è€—æ—¶ä¸è¶…è¿‡ 1usï¼Œå› æ­¤åŸºäº eventfd çš„è½»é‡çº§äº‹ä»¶å¾ªç¯ååˆ†é«˜æ•ˆã€‚
- **scheduler å¯¹ context çš„æ™ºèƒ½åŒ–ç®¡ç†ï¼š** åªè¦ç”¨æˆ·å‘`scheduler`æäº¤äº†ä»»åŠ¡ï¼Œé‚£ä¹ˆåªéœ€è¦è°ƒç”¨`scheduler::loop`ä¾¿å¯ä»¥è‡ªåŠ¨ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå¯¹äºç‰¹å®šçš„`context`å³ä½¿æ‰§è¡Œå®Œæ‰€æœ‰çš„ä»»åŠ¡ä¹Ÿä¸ä¼šç«‹åˆ»ç»ˆæ­¢ï¼Œå› ä¸ºåªè¦åˆ«çš„`context`è¿˜åœ¨è¿è¡Œå°±è¡¨æ˜`scheduler`å¯èƒ½ä¼šå‘è¯¥`context`æ´¾å‘æ–°ä»»åŠ¡ï¼Œåªæœ‰ç­‰å¾…å…¨éƒ¨`context`å‡æ‰§è¡Œå®Œä»»åŠ¡ï¼Œ`scheduler`æ‰ä¼šç»Ÿä¸€å‘é€åœæ­¢ä¿¡å·ã€‚ï¼ˆè¯¥éƒ¨åˆ†å®é™…æ›´å¤æ‚ï¼Œè¯»è€…å¯è‡ªè¡Œè¡¥å……ï¼‰
- **é«˜æ•ˆçš„åç¨‹åŒæ­¥ç»„ä»¶ï¼š** çº¿ç¨‹åŒæ­¥ç»„ä»¶ç”¨æ¥åŒæ­¥å¹¶å‘çº¿ç¨‹çš„è¡Œä¸ºï¼Œè€Œåç¨‹åŒæ­¥ç»„ä»¶åˆ™æ˜¯ç”¨æ¥åŒæ­¥å¹¶å‘åç¨‹çš„è¡Œä¸ºï¼Œå½“å‡½æ•°å› çº¿ç¨‹åŒæ­¥ç»„ä»¶è€Œé˜»å¡æ—¶ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œä½†å½“åç¨‹å‡½æ•°å› åç¨‹åŒæ­¥ç»„ä»¶é™·å…¥é˜»å¡æ—¶åªä¼šä½¿åç¨‹é™·å…¥é˜»å¡å¹¶è½¬ç§»æ‰§è¡Œæƒï¼Œæ­¤æ—¶çº¿ç¨‹ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œä¿è¯ CPU çš„é«˜åˆ©ç”¨ç‡ã€‚

### å¯èƒ½çš„ä¼˜åŒ–ç‚¹

tinyCoro éœ€è¦ä¼˜åŒ–çš„ç‚¹æœ‰å¾ˆå¤šï¼Œä¸»è¦åˆ†ä¸ºå¦‚ä¸‹ï¼š

- **sqe æ¶ˆè´¹é™åˆ¶ï¼š** tinyCoro åœ¨å‘èµ· IO å‰ä¼šå…ˆè·å– sqeï¼Œè€Œ io_uring çš„å¯ç”¨ sqe æ˜¯æœ‰é™åˆ¶çš„ï¼Œå¦‚æœå¯ç”¨ sqe æ¶ˆè´¹å®Œé‚£ä¹ˆ tinyCoro ä¼šå¾—åˆ°ç©ºæŒ‡é’ˆ sqe å¹¶ä¸”æ“ä½œè¯¥ sqe å°±ä¼šå¼•å‘ core dumpï¼Œåç»­å¯ä»¥å¯¹æ­¤è¿›è¡Œä¼˜åŒ–ã€‚
- **é«˜æ•ˆçš„è´Ÿè½½å‡è¡¡ï¼š** scheduler å¯¹å„ä¸ª context çš„ä»»åŠ¡æ´¾å‘é€»è¾‘æ˜¯ç”± dispatcher å†³å®šçš„ï¼Œç›®å‰ tinyCoro ä»…å®ç°äº† round-robin é€»è¾‘çš„ dispatcherï¼Œå¯ä»¥å†æ‹“å±• dispatcher çš„æ¨¡æ¿ç±»ä»è€Œå®ç°æ›´é«˜æ•ˆçš„è´Ÿè½½å‡è¡¡é€»è¾‘ã€‚
- **ç½‘ç»œå±‚åè®®æ‹“å±•ï¼š** tinyCoroLab é»˜è®¤æ·»åŠ äº† tcp æ”¯æŒï¼Œåç»­ä¼šå°è¯•æ·»åŠ  HTTP å’Œ rpc æ”¯æŒã€‚
- **å¤šçº¿ç¨‹æ‰§è¡Œå¼•æ“ä¼˜åŒ–ï¼š** ç›®å‰ tinyCoroLab çš„å¤šçº¿ç¨‹æ‰§è¡Œå¼•æ“æ˜¯æœ‰å¤šä¸ª context ç»„æˆå¹¶ç”± scheduler è´Ÿè´£ä»»åŠ¡è°ƒåº¦ï¼Œå„ä¸ª context ä¹‹é—´å½¼æ­¤ç‹¬ç«‹ä¸”å‡æŒæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å’Œä¸€ä¸ª io_uring å®ä¾‹ï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æœ‰æ•ˆé¿å…çº¿ç¨‹ç«äº‰å¸¦æ¥çš„æ¶ˆè€—ï¼Œåç»­ä¼šå‚è€ƒ golang çš„ gmp è®¾è®¡æ¥ä¼˜åŒ–æ­¤éƒ¨åˆ†ã€‚

### å¯èƒ½çš„é—®é¢˜

> ### ç”µæ¢¯è¯ï¼ˆ10 ç§’å¼€åœºï¼‰
>
> > tinyCoro æ˜¯ä¸€ä¸ªåŸºäº C++20 åç¨‹ + io_uring çš„å¼‚æ­¥ I/O æ¡†æ¶ã€‚åç¨‹ç”¨ `task` åšå¯è°ƒåº¦å•å…ƒï¼Œå³å€¼æäº¤æ—¶ `detach` æŠŠå¸§é‡Šæ”¾æƒäº¤ç»™å¼•æ“ï¼›æ¯ä¸ª `context` æ‹¥æœ‰ä¸€ä¸ª `engine` å’Œå·¥ä½œçº¿ç¨‹ï¼Œ`engine` ç»´æŠ¤ä»»åŠ¡é˜Ÿåˆ—ä¸ io_uringï¼Œäº‹ä»¶é€šçŸ¥ç”¨ eventfdï¼›`scheduler` è´Ÿè´£å¤š context çš„è´Ÿè½½åˆ†å‘ä¸ç»Ÿä¸€åœæœºã€‚å†™æ³•ä¿æŒåŒæ­¥é£æ ¼ï¼Œä½†å®é™…æ˜¯å¼‚æ­¥ã€äº‹ä»¶é©±åŠ¨ã€‚
>
> ### 1) æ¶æ„ & çº¿ç¨‹æ¨¡å‹
>
> **Qï¼šæ•´ä½“æ¶æ„æ€ä¹ˆç»„ç»‡çš„ï¼Ÿ**
>
> - **A**ï¼š`scheduler` æŒæœ‰ N ä¸ª `context`ï¼ˆé»˜è®¤ CPU é€»è¾‘æ ¸æ•°ï¼‰ï¼Œæ¯ä¸ª `context` ä¸€ä¸ª `jthread` + ç§æœ‰ `engine`ã€‚`engine` ç®¡ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMPMCï¼‰å’Œ io_uringï¼ˆç»‘å®š eventfdï¼‰ã€‚ä»»åŠ¡å¯è·¨çº¿ç¨‹æäº¤ï¼›io_uring çš„ `submit/wait/peek` åªåœ¨**æ‰€å±çº¿ç¨‹**è°ƒç”¨ï¼Œé¿å…è·¨çº¿ç¨‹é©±åŠ¨ uring çš„ç«æ€ã€‚
>
> **Qï¼šä¸ºä»€ä¹ˆç”¨ `jthread` è€Œä¸æ˜¯ `std::thread`ï¼Ÿ**
>
> - **A**ï¼š`jthread` è‡ªå¸¦è‡ªåŠ¨ `join` å’Œ `stop_token` å–æ¶ˆè¯­ä¹‰ï¼Œç®€åŒ–äº†é€€å‡ºä¸èµ„æºæ”¶æ•›ã€‚`context::notify_stop()` ç”¨ `request_stop()` + `engine.wake_up(1)` ç»„åˆï¼Œèƒ½ç«‹åˆ»å”¤é†’ `poll_submit()` çš„é˜»å¡ã€‚
>
> ### 2) task / åç¨‹è¯­ä¹‰
>
> **Qï¼š`task` çš„ä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ**
>
> - **A**ï¼š`task<T>` æ˜¯**å¯è°ƒåº¦å•å…ƒ + èµ„æºæ‰€æœ‰è€…**ã€‚åˆ›å»ºå³æŒ‚èµ·ï¼ˆ`initial_suspend = suspend_always`ï¼‰ï¼Œè°ƒåº¦æƒäº¤ç»™å¼•æ“ï¼›`final_suspend` ç”¨è‡ªå®šä¹‰ `FinalAwaiter` æ¢å¤çˆ¶åç¨‹ï¼Œä¿è¯â€œå­è·‘å®Œå›åˆ°è°ƒç”¨ç‚¹â€ï¼›å³å€¼æäº¤æ—¶ `detach()` æŠŠé”€æ¯æƒè½¬äº¤ç»™å¼•æ“ï¼Œ`engine.clean()` åªé”€æ¯ **detached** çš„åç¨‹å¸§ã€‚
>
> **Qï¼š`detach/clean` çš„æ­£ç¡®æ€§æ€ä¹ˆä¿è¯ï¼Ÿ**
>
> - **A**ï¼š`detach()` åœ¨ promise é‡Œæ‰“ `m_detached=true` å¹¶æ¸…ç©º `task` çš„å¥æŸ„ï¼›å¼•æ“ `exec_one_task()` é‡Œ `done()` åè°ƒç”¨å…¨å±€ `clean(h)`ï¼Œåªæœ‰ `detached` æ‰ `destroy()`ï¼Œé¿å…åŒåˆ ã€‚å·¦å€¼æäº¤ä¸ `detach`ï¼Œå¿…é¡»ä¿è¯ task ç”Ÿå‘½å‘¨æœŸè¦†ç›–æ‰§è¡Œã€‚
>
> **Qï¼šçˆ¶å­åç¨‹å¦‚ä½•å¯¹ç§°ç§»äº¤ï¼Ÿ**
>
> - **A**ï¼šçˆ¶ `co_await child` æ—¶ï¼Œ`task` awaiter çš„ `await_suspend` è®°å½•çˆ¶å¥æŸ„å¹¶**è¿”å›å­å¥æŸ„**ï¼ˆå¯¹ç§°ç§»äº¤ï¼Œå­ç«‹åˆ»è¿è¡Œï¼‰ã€‚å­åˆ° `final_suspend` æ—¶ `FinalAwaiter::await_suspend` æ¢å¤çˆ¶ï¼›éšåå¼•æ“çœ‹åˆ° `done()` å†æŒ‰ `detached` æ¸…ç†å­å¸§ã€‚
>
> ### 3) I/O æ¨¡å‹ï¼ˆio_uring + eventfdï¼‰
>
> **Qï¼šä¸€æ¬¡å¼‚æ­¥ I/O ä»å‘èµ·åˆ°æ¢å¤çš„å®Œæ•´æµç¨‹ï¼Ÿ**
>
> - **A**ï¼šåœ¨ awaiter æ„é€ æ—¶ï¼š`get_free_urs()` å– SQE â†’ `io_uring_prep_XXX` å¡«å…… â†’ `io_uring_sqe_set_data(io_info)` ç»‘å®šå›è°ƒä¸å¥æŸ„ â†’ `add_io_submit()`ï¼ˆ`pending++`ï¼‰ã€‚
>   `context::run()` è¿›å…¥ `engine.poll_submit()`ï¼šæŠŠ `pending` ä¸€æ¬¡æ€§ `submit()` åˆ°å†…æ ¸ï¼Œ`running += pendingï¼›pending=0`ï¼›`wait_eventfd()` é˜»å¡ç›´åˆ°äº‹ä»¶ï¼›æ‰¹é‡ `peek_batch_cqe()` â†’ `handle_cqe_entry(cqe)` å– `io_info` â†’ å›è°ƒé‡Œ `submit_to_context(io_info->handle)` æŠŠåç¨‹å¥æŸ„æŠ•å›ä»»åŠ¡é˜Ÿåˆ—ï¼›å¼•æ“éšå `exec_one_task()` æ¢å¤åç¨‹ï¼Œ`await_resume()` è¿”å› I/O ç»“æœã€‚
>
> **Qï¼šä¸ºä»€ä¹ˆåœ¨ `submit_task` ä¼šå†™ eventfd å”¤é†’ï¼ŸI/O è¿˜æ²¡å®Œæˆå•Šã€‚**
>
> - **A**ï¼š`poll_submit()` å†…éƒ¨ä¼š `wait_eventfd()` ä½œä¸º**ç»Ÿä¸€ç¡çœ ç‚¹**ã€‚æ–°ä»»åŠ¡åˆ°æ¥æ—¶å¿…é¡»æŠŠå·¥ä½œçº¿ç¨‹å”¤é†’ï¼Œå¦åˆ™å¾—ç­‰åˆ°æŸä¸ª I/O å®Œæˆæ‰ä¼šé†’ï¼Œè®¡ç®—ä»»åŠ¡ä¼šå»¶è¿Ÿã€‚å†™ eventfd çš„æ„ä¹‰æ˜¯â€œæœ‰äº‹å°±é†’â€ï¼Œä¸ç­‰ I/Oã€‚
>
> ### 4) äº‹ä»¶å¾ªç¯ & åœæœºåè®®
>
> **Qï¼š`context::run()` çš„å¾ªç¯ç­–ç•¥ï¼Ÿ**
>
> - **A**ï¼šæ¯è½®å…ˆæ‰¹é‡æ‰§è¡Œâ€œå½“å‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡â€ï¼ˆ`num_task_schedule()` æ¬¡ `exec_one_task()`ï¼‰ï¼Œç„¶åä¸è®ºæ˜¯å¦æœ‰ I/O éƒ½è¿›å…¥ `poll_submit()`ï¼ŒæŠŠå®ƒä½œä¸º**å”¯ä¸€ç¡çœ ç‚¹**ï¼šI/O å®Œæˆ / æ–°ä»»åŠ¡æäº¤ / åœæ­¢ä¿¡å·éƒ½ä¼šé€šè¿‡ eventfd å”¤é†’ï¼Œç®€åŒ–ç©ºé—²ç­‰å¾…çš„åˆ†æ”¯å¤æ‚åº¦ã€‚
>
> **Qï¼šå¦‚ä½•åˆ¤æ–­å¯ä»¥å®‰å…¨é€€å‡ºï¼Ÿä¼šä¸ä¼šæœ‰åç¨‹æ²¡æ¢å¤å°±é€€å‡ºï¼Ÿ**
>
> - **A**ï¼šé€€å‡ºæ¡ä»¶åœ¨ `context` å±‚ç»„åˆåˆ¤æ–­ï¼š`stop_requested && engine.ready()==false && engine.empty_io()==true && m_wait_cnt==0`ã€‚
>   å…¶ä¸­ `m_wait_cnt` æ˜¯**æŒ‚èµ·å¼•ç”¨è®¡æ•°**ï¼Œä¾‹å¦‚é‡åˆ°äº’æ–¥/æ¡ä»¶ç­‰å¾…ç­‰éœ€è¦ `register_wait()` / `unregister_wait()`ï¼Œé˜²æ­¢â€œä»æœ‰æŒ‚èµ·åç¨‹æ—¶è¿‡æ—©é€€å‡ºâ€é€ æˆæ³„æ¼ã€‚
>
> **Qï¼šå¤š context çš„ç»Ÿä¸€åœæœºç”±è°è´Ÿè´£ï¼Ÿ**
>
> - **A**ï¼š`scheduler::loop()` ç»™æ¯ä¸ª `context` æ³¨å…¥ `stop_cb`ã€‚å½“æŸä¸ª `context` åˆ¤æ–­è‡ªå·±è¾¾åˆ°â€œç»ˆæ€â€ï¼ˆæ— ä»»åŠ¡ã€æ—  I/Oã€æ— æŒ‚èµ·ï¼‰æ—¶è°ƒç”¨ `stop_cb`ï¼ŒæŠŠå¯¹åº” `flag` ç”± 1â†’0ï¼Œå¹¶æŠŠå…¨å±€æ´»è·ƒè®¡æ•° `m_stop_token--`ã€‚å½“ `m_stop_token == 0`ï¼ˆå…¨éƒ¨ç»ˆæ€ï¼‰æ—¶ï¼Œ`scheduler::stop_impl()` å¹¿æ’­ `notify_stop()` ç»™æ‰€æœ‰ contextã€‚å®è·µä¸Š `loop()` æœ«å°¾**å»ºè®® join æ‰€æœ‰ context**ï¼Œç›´åˆ°çº¿ç¨‹å…¨éƒ¨æ”¶æ•›å†è¿”å›ã€‚
>
> ### 5) è°ƒåº¦ä¸è´Ÿè½½å‡è¡¡
>
> **Qï¼šä»»åŠ¡å¦‚ä½•åˆ†å‘åˆ°ä¸åŒçš„ `context`ï¼Ÿ**
>
> - **A**ï¼š`scheduler` å†…ç½® `dispatcher`ï¼ˆé»˜è®¤ round-robinï¼‰ã€‚`submit(handle)` é€‰å‡º `ctx_id`ï¼Œå°†å¥æŸ„å‘ç»™è¯¥ context çš„ `engine`ã€‚æˆ‘è¿˜åšäº†â€œæ´»è·ƒè®¡æ•°ä¿®æ­£â€ï¼šè‹¥ä¸€ä¸ª context å…ˆå‰è¢«æ ‡è®°ä¸ºâ€œç»ˆæ€â€ï¼Œå†è¢«åˆ†é…æ–°ä»»åŠ¡æ—¶ä¼šé‡æ–°æŠŠå®ƒæ ‡è®°ä¸ºæ´»è·ƒï¼Œå¹¶æŠŠå…¨å±€è®¡æ•° +1ï¼Œé¿å…å‘â€œå·²ç»ˆæ€â€çš„ context æ´¾å‘ä»»åŠ¡ã€‚
>
> **Qï¼šå¦‚æœé˜Ÿåˆ—æ»¡äº†ä¼šæ€æ ·ï¼Ÿ**
>
> - **A**ï¼šå½“å‰ä½¿ç”¨ MPMC çš„ç¯å½¢é˜Ÿåˆ—ï¼Œæç«¯æƒ…å†µä¸‹å¯èƒ½é€€åŒ–ä¸ºå¿™ç­‰æˆ–æ‹’ç»å…¥é˜Ÿï¼›åç»­å¯ä»¥åŠ  backpressureï¼ˆä¾‹å¦‚é™æµã€æ‰¹æäº¤ã€æˆ–åœ¨ `submit_task` ä¸Šåšç­‰å¾…/é‡è¯•ç­–ç•¥ï¼‰ã€‚
>
> ### 6) æ­£ç¡®æ€§ä¸å¹¶å‘
>
> **Qï¼šå¦‚ä½•é¿å…æ­»ç­‰æˆ–ç¡æ­»ï¼Ÿ**
>
> - **A**ï¼šæ‰€æœ‰éœ€è¦å”¤é†’çš„è·¯å¾„éƒ½å†™ eventfdï¼šæ–°ä»»åŠ¡æäº¤ã€I/O å®Œæˆï¼ˆå†…æ ¸å†™ï¼‰ã€åœæ­¢ä¿¡å·ï¼ˆ`notify_stop()` å†™ï¼‰ã€‚å› æ­¤ `poll_submit()` ä¸ä¼šç¡æ­»ã€‚
>   æ³¨æ„ `submit_task()` å¿…é¡»å†™ eventfdï¼Œå¦åˆ™åªæœ‰ I/O æ‰èƒ½æŠŠçº¿ç¨‹å«é†’ã€‚
>
> **Qï¼šio_uring çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ**
>
> - **A**ï¼šio_uring å®˜æ–¹å»ºè®®ä¸€ä¸ªå®ä¾‹ç”±ä¸€ä¸ªçº¿ç¨‹é©±åŠ¨ï¼›æˆ‘çš„å®ç°ä¸­ awaiter æ„é€ åªä»**æœ¬çº¿ç¨‹çš„ engine** å– SQEï¼Œ`submit/wait/peek` ä¹Ÿåªåœ¨æœ¬çº¿ç¨‹è°ƒç”¨ã€‚è·¨çº¿ç¨‹äº¤äº’åªå‘ç”Ÿåœ¨**ä»»åŠ¡é˜Ÿåˆ—**ï¼Œå®ƒæ˜¯ MPMC çš„ã€‚
>
> **Qï¼šå¼‚å¸¸ä¸è¿”å›å€¼å¦‚ä½•ä¼ é€’ï¼Ÿ**
>
> - **A**ï¼šé€šè¿‡ `task`/`promise`ï¼š`task<T>` åœ¨ promise å®¹å™¨å­˜å€¼ï¼›`task<void>` åœ¨ promise å­˜ `exception_ptr` å¹¶åœ¨ `await_resume()` é‡æ–°æŠ›å‡ºï¼Œè¡¨ç°ä¸ºâ€œåƒåŒæ­¥è°ƒç”¨é‚£æ ·è¿”å›/æŠ›å‡ºâ€ã€‚
>
> ### 7) æ€§èƒ½ & å¯¹æ¯”
>
> **Qï¼šç›¸å¯¹ epoll/çº¿ç¨‹æ± å›è°ƒå¼ï¼Œä¼˜åŠ¿åœ¨å“ªï¼Ÿ**
>
> - **A**ï¼šç¼–ç¨‹æ¨¡å‹ä¿æŒåŒæ­¥é£æ ¼ï¼ˆå¯è¯»æ€§ä¸å¯ç»´æŠ¤æ€§å¥½ï¼‰ï¼›io_uring å‡å°‘ syscalls/context switchï¼›eventfd ä½œä¸ºè½»é‡é€šçŸ¥ï¼ˆå•æ¬¡è¯»å†™äºšå¾®ç§’çº§ï¼‰ï¼›æ¯ä¸ª context ä¸€æ¡â€œçƒ­è·¯å¾„â€ï¼Œå‡å°‘å…±äº«ç«äº‰ã€‚
>   æ½œåœ¨æå‡ç‚¹ï¼šæ‰¹é‡è°ƒåº¦ã€æ›´æ™ºèƒ½çš„ dispatcherï¼ˆNUMA/è´Ÿè½½è‡ªé€‚åº”ï¼‰ã€timer/è¶…æ—¶ awaiterã€work-stealing ç­‰ã€‚
>
> ### 8) å¸¸è§è¿½é—® & å»ºè®®å›ç­”
>
> - **ä¸ºä»€ä¹ˆ `poll_submit()` æ¯è½®éƒ½è°ƒç”¨ï¼Ÿ**
>   ç»Ÿä¸€ç¡çœ ç‚¹ç®€åŒ–åˆ†æ”¯ï¼›æ—  I/O æ—¶ä¼šç¡åœ¨ `wait_eventfd()`ï¼Œä½†æ–°ä»»åŠ¡/åœæ­¢ä¿¡å·ä¼šå†™ eventfd åŠæ—¶å”¤é†’ï¼Œä¸ä¼šå¯¼è‡´â€œæœ‰ä»»åŠ¡å´ä¸è·‘â€ã€‚ï¼ˆå¦‚æœé¢è¯•å®˜å»ºè®®åªåœ¨ `!empty_io()` æ—¶ `poll`ï¼Œå¯ä»¥è§£é‡Šæˆâ€œç®€å•æ­£ç¡®ä¼˜å…ˆâ€çš„å–èˆï¼Œä¸¤ç§éƒ½èƒ½å·¥ä½œã€‚ï¼‰
> - **å• context åœºæ™¯å¦‚ä½•è‡ªåŠ¨åœæœºï¼Ÿ**
>   `start()` ç¼ºçœæ³¨å…¥ `m_stop_cb = request_stop()`ï¼›å½“ `empty_wait_task()` ä¸”é˜Ÿåˆ—ç©ºæ—¶è‡ªåœï¼Œ`notify_stop()` ä¸€æ ·ä¼š wakeupï¼Œä¿è¯ä¸ç¡æ­»ã€‚
> - **æäº¤åœ¨ `loop()` ç»“æŸåæ€ä¹ˆåŠï¼Ÿ**
>   ä»£ç é‡Œæœ‰æ–­è¨€ä¿æŠ¤ï¼ˆ`m_stop_token != 0`ï¼‰ï¼Œå¹¶ä¸” `stop_cb` åªåœ¨â€œçœŸçš„ç»ˆæ€â€æ‰æŠŠè®¡æ•°å‡åˆ° 0ï¼Œé¿å…æ—©åœåå†æ´¾å‘ã€‚
