---
title: "入门"
date: 2024-10-17T14:38:29+08:00
Categories: [编译器,llvm]
---

LLVM, 最初是「low level virtual machine」的缩写，因为一开始只是以为作为一个优化方面的项目，但是后面变成编译器了，于是这个说法就没有了，但是简称还是保留了下来。

LLVM是一个 **编译器框架**, 因此需要前端(front-end)来将源代码解析并转换为LLVM中间表示(**LLVM IR**)。

下面的图片是Clang/LLVM的简单架构，也就是把LLVM作为前端。在最初时，LLVM的前端是gcc, 但是后来Apple开发了Clang取代了它。我们也可以自己开发前端从而与LLVM配合起来，实现我们自定义的编程语言的编译器。

> **现在带有Dragon Egg的GCC还是可以生成LLVM IR**

<img src="https://pic3.zhimg.com/80/v2-e93d22914f2939017db6c6ff463cc2d8_1440w.webp" alt="img" style="zoom:50%;" />

可以看出来，LLVM作为一个编译器框架，它是由各个模块组合来的，所谓框架意思就是说，我们可以基于LLVM提供的功能来开发自己的模块并集成在LLVM系统上，从而增加功能。



## TableGen

TableGen是一种语言,专门用于描述LLVM内部的各种数据结构和模式的域特定语言(DSL)。通过TableGen文件，开发者可以以声明性方式定义复杂的结构、指令集、优化规则等。它的功能就是读取一个文件（td文件），解析这个文件，输出成不同的结果文件（比如说C++语法的.inc后缀文件）。现在来说，其服务的功能模块主要有2个，分别是LLVM后端的**平台不相关**的[代码生成](https://zhida.zhihu.com/search?content_id=119524076&content_type=Article&match_order=1&q=代码生成&zhida_source=entity)（`target independent code generator`）阶段，以及Clang前端的代码诊断功能。



`llvm-tblgen` 则负责将这些定义转换为C++代码或其他所需的输出。`llvm-tblgen`在正常的编译流程中并不参与，这是额外的开发工具，可以用来调度整个TableGen工作流。

> TableGen的前端与后端的工作分别是:
>
> **前端：** 
>
> + **解析器（Parser）**：负责读取和解析 **TableGen** 的输入文件（通常是 `.td` 文件），将其转换为 **TableGen** 的内部表示（如抽象语法树，AST）。
>
>   **语义分析（Semantic Analysis）**：检查输入文件的语法和语义是否正确，确保定义的一致性和正确性。例如，验证类的继承关系、属性类型等。
>
> **后端**指的是 **TableGen** 根据前端生成的内部表示，生成具体输出的部分
>
> + **代码生成器（Code Generators）**：根据不同的需求，生成相应的代码或数据结构。例如，生成指令选择器代码、寄存器描述代码等。
>
> + **输出格式**：可以是 C++ 代码、头文件、数据表，甚至是其他格式的文件，具体取决于 **TableGen** 后端的设计和用途。

### 用法

首先要明确，TableGen主要是用来 **描述信息的**（强类型的语法），这也就是说它几乎是没有 **控制流的语法规范**，同时也不关心语言本身的意义是否正确——这是由TableGen后端关心的。

**注释**

可以使用`//`或者`/* */`

**数据类型**

TableGen是一个强类型语言，它的覆盖范围非常广，从位类型到dag类型都有，甚至还支持类参数类型的扩展和列表的扩展。

主要类型有:

\- `bit`：一位就是表示一个布尔值，比如0或者1；

\- `int`：表示一个32位的整形值，比如5；

\- `string`：表示一个有序的固定长度的字符序列，比如“add”；

\- `code`：表示一个代码片段，可以是单行或多行，不过其实和`string`本质一样，只是展示的意义不同而已；

\- `bits<n>`：`bit`的扩展，可以指定n个位同时赋值，比如当n=3，可以是010，指定位模式时特别常用；

\- `list<ty>`：很灵活的一个类型，可以保存指定ty类型的数据的列表，ty类型也可以是另一个`list<ty>`，可以理解是C++中的List模板类；

\- `class`：指定一些类型数据的集合表示，必须用def或defm来使用这个类定义记录之后，内部数据才被分配。用来声明多个记录的共有信息，支持继承和重载等特性；

\- `dag`：表示可嵌套的有向无环图元素；

原文中指出：当前这些数据类型已经足够使用，如果日后还添加其他数据类型，再另行发布（我也不知道会不会更新这篇文章，以官方为准）





